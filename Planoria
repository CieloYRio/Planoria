<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> data-i18n=EduFlow Planner - Smart Curriculum Design</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', 'Geist', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI Variable', 'Segoe UI', system-ui, ui-sans-serif, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 25%, #ecfdf5 50%, #f0fdf4 75%, #f8fafc 100%);
            min-height: 100vh;
            padding: 20px;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            font-optical-sizing: auto;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(14, 165, 233, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 
                0 32px 64px rgba(14, 165, 233, 0.15), 
                0 16px 32px rgba(16, 185, 129, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.2);
            overflow: hidden;
            border: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #0ea5e9 0%, #06b6d4 25%, #10b981 50%, #059669 75%, #047857 100%);
            z-index: 1;
        }

        .header {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 25%, #10b981 50%, #059669 75%, #047857 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="20" cy="80" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            font-weight: 800;
            background: linear-gradient(45deg, #ffffff, #f1f5f9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        /* Subtitle stays as you had it */
        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            font-weight: 500;
            position: relative;
        z-index: 1;
        }

        /* NEW: Exclude emoji from gradient */
        .header h1 .emoji {
            -webkit-background-clip: initial;
            -webkit-text-fill-color: initial;
            background: none;
            color: inherit; /* Let system/browser show native emoji color */
        }

        .nav-tabs {
            display: flex;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            padding: 8px;
            gap: 4px;
        }

        .nav-tab {
            flex: 1;
            padding: 16px 24px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            position: relative;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            transform: translateY(-1px);
        }

        .content {
            padding: 30px;
        }

        .view {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .form-control:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 
                0 0 0 3px rgba(14, 165, 233, 0.1),
                0 4px 12px rgba(14, 165, 233, 0.15);
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }

        .form-control:hover:not(:focus) {
            border-color: rgba(14, 165, 233, 0.4);
            background: rgba(255, 255, 255, 0.95);
        }

        .btn {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(14, 165, 233, 0.4);
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 50%, #075985 100%);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .curriculum-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .subject-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(226, 232, 240, 0.6);
            border-radius: 20px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(14, 165, 233, 0.08);
        }

        .subject-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0ea5e9 0%, #06b6d4 25%, #10b981 50%, #059669 75%, #047857 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .subject-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 50px rgba(14, 165, 233, 0.2);
            border-color: rgba(14, 165, 233, 0.4);
            background: rgba(255, 255, 255, 0.95);
        }

        .subject-card:hover::before {
            opacity: 1;
        }

        .subject-card h3 {
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .subject-card p {
            color: #6b7280;
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .progress-bar {
            background: #f3f4f6;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .lesson-list {
            list-style: none;
            margin-top: 16px;
        }

        .lesson-item {
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lesson-item:last-child {
            border-bottom: none;
        }

        .lesson-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-completed {
            background: #dcfce7;
            color: #166534;
        }

        .status-in-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .status-not-started {
            background: #f3f4f6;
            color: #6b7280;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 28px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid rgba(226, 232, 240, 0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.08);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981 0%, #059669 50%, #047857 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.4);
            background: rgba(255, 255, 255, 0.95);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.9) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 5px;
        }

        .close-modal:hover {
            color: #374151;
        }

        .planner-tab {
            flex: 1;
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .planner-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .planner-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .planner-view {
            display: none;
        }

        .planner-view.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .curriculum-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
     <div class="header">
  <h1>
    <span class="emoji">ğŸ“’</span> EduFlow Planner
  </h1>
  <p id="headerSubtitle">Smart Curriculum Design for Modern Educators</p>
</div>
    
       <!-- Participant Information Section -->
<div id="headerSubtitle" style="padding: 20px 40px; background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%); border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
    <div style="
        display: grid;
        grid-template-columns: repeat(3, minmax(250px, 1fr));
        grid-template-rows: auto auto;
        gap: 20px;
        margin-bottom: 16px;
    ">
        <!-- Row 1 -->
        <div class="form-group" style="margin-bottom: 0;">
            <label for="learnerName" style="font-size: 0.9rem; color: #374151; margin-bottom: 6px;">ğŸ‘¨â€ğŸ“ Learner's Name</label>
            <input type="text" id="learnerName" class="form-control" placeholder="Enter learner's name" style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(59, 130, 246, 0.3);">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="teacherName" style="font-size: 0.9rem; color: #374151; margin-bottom: 6px;">ğŸ‘©â€ğŸ« Teacher's Name</label>
            <input type="text" id="teacherName" class="form-control" placeholder="Enter teacher's name" style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(16, 185, 129, 0.3);">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="schoolName" style="font-size: 0.9rem; color: #374151; margin-bottom: 6px;">ğŸ« School/Institution</label>
            <input type="text" id="schoolName" class="form-control" placeholder="Enter school/institution" style="background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(16, 185, 129, 0.3);">
        </div>

        <!-- Row 2 (centered with spacing above) -->
        <div style="grid-column: 1 / span 3; display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
            <div class="form-group" style="margin-bottom: 0; width: 250px;">
                <label for="displayGrade" style="font-size: 0.9rem; color: #374151; margin-bottom: 6px;">ğŸ“ Grade Level</label>
                <input type="text" id="displayGrade" class="form-control" placeholder="Grade level will appear here" readonly style="background: rgba(243, 244, 246, 0.8); border: 1px solid rgba(156, 163, 175, 0.3); color: #6b7280;">
            </div>
            <div class="form-group" style="margin-bottom: 0; width: 250px;">
                <label for="displayYear" style="font-size: 0.9rem; color: #374151; margin-bottom: 6px;">ğŸ“… Academic Year</label>
                <input type="text" id="displayYear" class="form-control" placeholder="Academic year will appear here" readonly style="background: rgba(243, 244, 246, 0.8); border: 1px solid rgba(156, 163, 175, 0.3); color: #6b7280;">
            </div>
        </div>
    </div>
</div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showView('overview')">ğŸ“Š Overview</button>
            <button class="nav-tab" onclick="showView('subjects')">ğŸ“– Subjects</button>
            <button class="nav-tab" onclick="showView('planner')">ğŸ“‹ Curriculum Designer</button>
            <button class="nav-tab" onclick="showView('schedule')">ğŸ• Daily Schedule</button>
            <button class="nav-tab" onclick="showView('progress')">ğŸ“ˆ Progress</button>
        </div>

        <div class="content">
            <!-- Overview View -->
            <div id="overview" class="view active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalSubjects">6</div>
                        <div class="stat-label">Total Subjects</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedLessons">0</div>
                        <div class="stat-label">Completed Lessons</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="overallProgress">0</div>
                        <div class="stat-label">Overall Progress %</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="weeklyHours">0</div>
                        <div class="stat-label">Weekly Hours</div>
                    </div>
                </div>

                <h2 style="margin-bottom: 20px; color: #1f2937;">Recent Activity</h2>
                <div class="curriculum-grid">
                    <div class="subject-card">
                        <h3>ğŸ”¢ Mathematics</h3>
                        <p>Ready to start: No lessons added yet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <small style="color: #6b7280;">0% Complete</small>
                    </div>
                    <div class="subject-card">
                        <h3>ğŸ”¬ Science</h3>
                        <p>Ready to start: No lessons added yet</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <small style="color: #6b7280;">0% Complete</small>
                    </div>
                </div>
            </div>

            <!-- Subjects View -->
            <div id="subjects" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #1f2937;">Subject Management</h2>
                    <button class="btn" onclick="openModal('addSubjectModal')">
                        â• Add Subject
                    </button>
                </div>

                <div class="curriculum-grid" id="subjectsGrid">
                    <!-- Subjects will be populated by JavaScript -->
                </div>
            </div>

            <!-- Planner View -->
            <div id="planner" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #1f2937; margin: 0;">Curriculum Planner</h2>
                </div>
                


                <!-- Unified Calendar & Academic Configuration -->
                <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #0ea5e9; margin-bottom: 20px; border-left: 6px solid #0ea5e9;">
                    <h3 style="margin-bottom: 20px; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                        ğŸ“… Academic Calendar Configuration
                        <span style="font-size: 0.8rem; background: #0ea5e9; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 500;">Applies to Both Views</span>
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="globalCountryRegion">ğŸŒ Country/Region</label>
                            <select id="globalCountryRegion" class="form-control" onchange="updateGlobalCountrySettings()">
                                <option value="us">ğŸ‡ºğŸ‡¸ United States</option>
                                <option value="uk">ğŸ‡¬ğŸ‡§ United Kingdom</option>
                                <option value="ca">ğŸ‡¨ğŸ‡¦ Canada</option>
                                <option value="au">ğŸ‡¦ğŸ‡º Australia</option>
                                <option value="nz">ğŸ‡³ğŸ‡¿ New Zealand</option>
                                <option value="sg">ğŸ‡¸ğŸ‡¬ Singapore</option>
                                <option value="in">ğŸ‡®ğŸ‡³ India</option>
                                <option value="cn">ğŸ‡¨ğŸ‡³ China</option>
                                <option value="kr">ğŸ‡°ğŸ‡· South Korea</option>
                                <option value="jp">ğŸ‡¯ğŸ‡µ Japan</option>
                                <option value="th">ğŸ‡¹ğŸ‡­ Thailand</option>
                                <option value="my">ğŸ‡²ğŸ‡¾ Malaysia</option>
                                <option value="ph">ğŸ‡µğŸ‡­ Philippines</option>
                                <option value="id">ğŸ‡®ğŸ‡© Indonesia</option>
                                <option value="ae">ğŸ‡¦ğŸ‡ª UAE</option>
                                <option value="sa">ğŸ‡¸ğŸ‡¦ Saudi Arabia</option>
                                <option value="qa">ğŸ‡¶ğŸ‡¦ Qatar</option>
                                <option value="tr">ğŸ‡¹ğŸ‡· Turkey</option>
                                <option value="de">ğŸ‡©ğŸ‡ª Germany</option>
                                <option value="fr">ğŸ‡«ğŸ‡· France</option>
                                <option value="other">ğŸŒ Other/Add Country</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="globalCalendarSystem">ğŸ“Š Calendar System</label>
                            <select id="globalCalendarSystem" class="form-control" onchange="updateGlobalCalendarSystem()">
                                <option value="quarterly">Quarterly (4 periods)</option>
                                <option value="semester">Semester (2 periods)</option>
                                <option value="trimester">Trimester (3 periods)</option>
                                <option value="monthly">Monthly (12 periods)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="globalSchoolYearStart">ğŸ—“ï¸ School Year Start</label>
                            <input type="month" id="globalSchoolYearStart" class="form-control" onchange="updateAcademicYearFromStart(); updateGlobalCalendarSystem();">
                        </div>
                        
                        <div class="form-group">
                            <label for="globalAcademicYear">ğŸ“š Academic Year</label>
                            <select id="globalAcademicYear" class="form-control">
                                <option value="2024-2025">2024-2025</option>
                                <option value="2025-2026">2025-2026</option>
                                <option value="2026-2027">2026-2027</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="globalGradeLevel">ğŸ“ Grade Level</label>
                            <select id="globalGradeLevel" class="form-control">
                                <option value="">Select Grade</option>
                                <option value="k">Kindergarten</option>
                                <option value="1">Grade 1</option>
                                <option value="2">Grade 2</option>
                                <option value="3">Grade 3</option>
                                <option value="4">Grade 4</option>
                                <option value="5">Grade 5</option>
                                <option value="6">Grade 6</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                                <option value="10">Grade 10</option>
                                <option value="11">Grade 11</option>
                                <option value="12">Grade 12</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="globalInterfaceLanguage">ğŸŒ Interface Language</label>
                            <select id="globalInterfaceLanguage" class="form-control">
                                <option value="en">English</option>
                                <option value="es">EspaÃ±ol</option>
                                <option value="fr">FranÃ§ais</option>
                                <option value="de">Deutsch</option>
                                <option value="zh">ä¸­æ–‡</option>
                                <option value="ja">æ—¥æœ¬èª</option>
                                <option value="ko">Korean - (í•œêµ­ì–´)</option>
                                <option value="ar">Arabic - (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Curriculum Information Display -->
                    <div id="globalCurriculumInfo" style="padding: 16px; background: #f0f9ff; border-radius: 12px; border-left: 4px solid #0ea5e9; display: none;">
                        <h4 style="margin-bottom: 8px; color: #0c4a6e;">ğŸ“‹ Curriculum Standards</h4>
                        <p id="globalCurriculumStandards" style="margin: 0; color: #0369a1; font-weight: 500;"></p>
                    </div>
                    
                    <!-- Term-based Countries Note -->
                    <div id="termBasedNote" style="padding: 12px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b; margin-top: 16px; display: none;">
                        <p style="margin: 0; font-size: 0.9rem; color: #92400e;">
                            <strong>ğŸ“ Note for Term-Based Countries:</strong> Quarter and traditional semester options are not available for term-based education systems (UK, Australia, etc.). Use "Term" or "Two Terms" options instead.
                        </p>
                    </div>
                </div>
                
                <!-- Planner Navigation -->
                <div style="display: flex; gap: 12px; margin-bottom: 30px; background: #f8fafc; padding: 8px; border-radius: 12px;">
                    <button class="planner-tab active" onclick="showPlannerView('subject-wise')">ğŸ“š Subject-Wise Planning</button>
                    <button class="planner-tab" onclick="showPlannerView('period-wise')">ğŸ“… Period-Wise Planning</button>
                </div>

                <!-- Subject-Wise View -->
                <div id="subject-wise" class="planner-view active">
                    <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 20px; color: #1f2937;">Subject Focus Planning</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="subjectSelect">ğŸ“š Select Subject to Plan</label>
                                <select id="subjectSelect" class="form-control" onchange="updateSubjectTitle()">
                                    <option value="">Choose a subject to focus on</option>
                                    <option value="mathematics">ğŸ”¢ Mathematics</option>
                                    <option value="science">ğŸ”¬ Science</option>
                                    <option value="english">ğŸ“ English</option>
                                    <option value="history">ğŸ›ï¸ History</option>
                                    <option value="art">ğŸ¨ Art</option>
                                    <option value="music">ğŸµ Music</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="subjectFocus">ğŸ¯ Planning Focus</label>
                                <select id="subjectFocus" class="form-control" onchange="updatePlanningFocus()">
                                    <option value="unit">Single Unit/Topic (4-6 weeks)</option>
                                    <option value="quarter">Quarter/Term (10-12 weeks)</option>
                                    <option value="two-terms">Two Terms (20-28 weeks)</option>
                                    <option value="semester">Full Semester (18-20 weeks)</option>
                                    <option value="year">Entire Academic Year (36-40 weeks)</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn" onclick="generateSubjectPlan()">ğŸ”„ Generate Subject-Focused Plan</button>
                    </div>

                    <!-- Monthly Planning Table -->
                    <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                        <h3 id="monthlyPlanningTitle" style="margin-bottom: 20px; color: #1f2937;">Monthly Curriculum Planning</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #2563eb 0%, #3b82f6 50%, #1d4ed8 100%);">
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Time Period</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Months</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Core Concepts</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Guiding Questions</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Skills</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Activities</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Evidence of Learning</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Resources</th>
                                        <th style="padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;">Standard Alignments</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyPlanTable">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn" onclick="addMonthlyRow()">â• Add Period</button>
                            <button class="btn btn-secondary" onclick="addColumnToTable()">ğŸ“Š Add Column</button>
                        </div>
                    </div>

                    <!-- Additional Planning Sections -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 20px;">
                        <!-- First Row - Most Important -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                            <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                                <h3 style="margin-bottom: 16px; color: #1f2937;">ğŸ¯ Unit Learning Goals</h3>
                                <textarea id="learningGoals" class="form-control" rows="4" placeholder="Define the overarching goals and outcomes for this unit..."></textarea>
                            </div>
                            
                            <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                                <h3 style="margin-bottom: 16px; color: #1f2937;">ğŸ“‹ Prerequisites</h3>
                                <textarea id="prerequisites" class="form-control" rows="4" placeholder="List the knowledge and skills students should have before starting..."></textarea>
                            </div>
                        </div>
                        
                        <!-- Second Row - Supporting Information -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                            <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                                <h3 style="margin-bottom: 16px; color: #1f2937;">ğŸ“ Teaching Notes & Tips</h3>
                                <textarea id="teachingNotes" class="form-control" rows="4" placeholder="Important teaching strategies, common challenges, and helpful tips..."></textarea>
                            </div>
                            
                            <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                                <h3 style="margin-bottom: 16px; color: #1f2937;">ğŸ—ºï¸ Cross-Curricular Connections</h3>
                                <textarea id="mappingInsights" class="form-control" rows="4" placeholder="Connections to other subjects and interdisciplinary opportunities..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Period-Wise View -->
                <div id="period-wise" class="planner-view">
                    <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 20px; color: #1f2937;">Multi-Subject Period Planning</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="periodSelect" id="periodLabel">ğŸ“… Select Period to Plan</label>
                                <select id="periodSelect" class="form-control">
                                    <option value="q1">Quarter 1 (Sep-Nov)</option>
                                    <option value="q2">Quarter 2 (Dec-Feb)</option>
                                    <option value="q3">Quarter 3 (Mar-May)</option>
                                    <option value="q4">Quarter 4 (Jun-Aug)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="planningScope">ğŸ¯ Planning Scope</label>
                                <select id="planningScope" class="form-control" onchange="updatePlanningScope()">
                                    <option value="all">All Subjects (Complete curriculum)</option>
                                    <option value="core">Core Subjects Only (Math, English, Science, History)</option>
                                    <option value="selected">Selected Subjects (Choose specific subjects)</option>
                                    <option value="interdisciplinary">Interdisciplinary (Cross-subject themes)</option>
                                </select>
                            </div>
                        </div>
                        
                        <button class="btn" onclick="generatePeriodPlan()">ğŸ”„ Generate Multi-Subject Plan</button>
                    </div>

                    <!-- Weekly Planning Table -->
                    <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                        <h3 style="margin-bottom: 20px; color: #1f2937;">Weekly Subject Planning</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%);">
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 120px;">Subject</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 150px;">Textbook</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week1Header">Week 1</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week2Header">Week 2</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week3Header">Week 3</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week4Header">Week 4</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week5Header">Week 5</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week6Header">Week 6</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week7Header">Week 7</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week8Header">Week 8</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week9Header">Week 9</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week10Header">Week 10</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week11Header">Week 11</th>
                                        <th style="padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;" id="week12Header">Week 12</th>
                                    </tr>
                                </thead>
                                <tbody id="weeklyPlanTable">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn" onclick="addSubjectRow()">â• Add Subject</button>
                            <button class="btn btn-secondary" onclick="addWeekColumn()">ğŸ“… Add Week</button>
                            <button class="btn" onclick="markWeekComplete()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                âœ… Mark Current Week Complete
                            </button>
                        </div>
                        
                        <!-- Week Completion Guide -->
                        <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-top: 16px;">
                            <p style="margin: 0; font-size: 0.9rem; color: #1e40af;">
                                <strong>ğŸ“… Week Completion Guide:</strong> Fill in your weekly planning for all subjects, then click "Mark Current Week Complete" to track your progress. This helps with milestone tracking and shows your planning completion status.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Schedule View -->
            <div id="schedule" class="view">
                <h2 style="margin-bottom: 20px; color: #1f2937;">Daily Schedule Template</h2>
                
                <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0; color: #1f2937;">ğŸ“… Schedule Configuration</h3>
                        <button class="btn btn-secondary" onclick="showWeeklyView()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            ğŸ“… View Full Week
                        </button>
                    </div>
                    
                    <!-- Auto-Update Note -->
                    <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 16px;">
                        <p style="margin: 0; font-size: 0.9rem; color: #065f46;">
                            <strong>ğŸ”„ Auto-Sync:</strong> The weekly view automatically updates when you fill in daily schedules. Add time slots and subjects below, then click "View Full Week" to see your complete schedule.
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="scheduleDay">Day of Week</label>
                            <select id="scheduleDay" class="form-control" onchange="updateDaySchedule()">
                                <option value="monday">Monday</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="friday">Friday</option>
                                <option value="saturday">Saturday</option>
                                <option value="sunday">Sunday</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="scheduleDate">Date</label>
                            <input type="date" id="scheduleDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="scheduleTemplate">Template Type</label>
                            <select id="scheduleTemplate" class="form-control" onchange="loadScheduleTemplate()">
                                <option value="standard">Standard Day (8 AM - 3 PM)</option>
                                <option value="extended">Extended Day (7 AM - 5 PM)</option>
                                <option value="flexible">Flexible Schedule</option>
                                <option value="custom">Custom Template</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Daily Schedule Table -->
                <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                    <h3 style="margin-bottom: 20px; color: #1f2937;">ğŸ• Time Slot Schedule</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);">
                                  <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Time Slot</th>
                                  <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 150px;">Subject/Activity</th>
                                  <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 200px;">Learning Objectives</th>
                                  <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 200px;">Activities & Tasks</th>
                                  <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 150px;">Materials Needed</th>
                                  <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Notes</th>
                                  <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 150px;">Progress Matrix</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTable">
                                <!-- Schedule rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn" onclick="addTimeSlot()">â• Add Time Slot</button>
                        <button class="btn btn-secondary" onclick="markDayComplete()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            âœ… Mark Day Complete
                        </button>
                    </div>
                </div>
            </div>

            <!-- Progress View -->
            <div id="progress" class="view">
                <h2 style="margin-bottom: 20px; color: #1f2937;">Progress Tracking</h2>
                
                <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 16px; color: #1f2937;">Subject Progress</h3>
                    <div id="progressCharts">
                        <!-- Progress charts will be populated by JavaScript -->
                    </div>
                </div>

                <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb;">
                    <h3 style="margin-bottom: 16px; color: #1f2937;">Achievement Milestones</h3>
                    <div id="milestones">
                        <!-- Milestones will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="background: white; border-radius: 16px; padding: 24px; border: 2px solid #e5e7eb; margin-top: 30px;">
                <h3 style="margin-bottom: 16px; color: #1f2937;">ğŸ“„ Export & Save Options</h3>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn" onclick="exportToPDF()">
                        ğŸ“„ Export PDF
                    </button>
                    <button class="btn btn-secondary" onclick="printPlanner()">
                        ğŸ–¨ï¸ Print
                    </button>
                    <button class="btn" onclick="saveTemplate()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        ğŸ’¾ Save Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Subject Modal -->
    <div id="addSubjectModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('addSubjectModal')">&times;</button>
            <h3 style="margin-bottom: 20px; color: #1f2937;">Add New Subject</h3>
            <form onsubmit="addSubject(event)">
                <div class="form-group">
                    <label for="subjectName">Subject Name</label>
                    <input type="text" id="subjectName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="subjectEmoji">Emoji</label>
                    <input type="text" id="subjectEmoji" class="form-control" placeholder="ğŸ“š" maxlength="2">
                </div>
                <div class="form-group">
                    <label for="subjectDescription">Description</label>
                    <textarea id="subjectDescription" class="form-control" rows="3"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addSubjectModal')">Cancel</button>
                    <button type="submit" class="btn">Add Subject</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Weekly Schedule Modal -->
    <div id="weeklyScheduleModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
            <button class="close-modal" onclick="closeModal('weeklyScheduleModal')">&times;</button>
            <h3 style="margin-bottom: 20px; color: #1f2937;">ğŸ“… Weekly Schedule Overview</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);">
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 100px;">Time</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Monday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Tuesday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Wednesday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Thursday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Friday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Saturday</th>
                            <th style="padding: 12px; border: 1px solid #92400e; font-weight: 600; color: white; min-width: 120px;">Sunday</th>
                        </tr>
                    </thead>
                    <tbody id="weeklyScheduleTable">
                        <!-- Weekly schedule will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="exportWeeklySchedule()">ğŸ“„ Export Weekly Schedule</button>
                <button class="btn" onclick="closeModal('weeklyScheduleModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Lesson Modal -->
    <div id="addLessonModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('addLessonModal')">&times;</button>
            <h3 style="margin-bottom: 20px; color: #1f2937;">Add New Lesson</h3>
            <form onsubmit="addLesson(event)">
                <div class="form-group">
                    <label for="lessonSubject">Subject</label>
                    <select id="lessonSubject" class="form-control" required>
                        <option value="">Select a subject</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lessonTitle">Lesson Title</label>
                    <input type="text" id="lessonTitle" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="lessonDate">Date</label>
                    <input type="date" id="lessonDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="lessonDuration">Duration (minutes)</label>
                    <input type="number" id="lessonDuration" class="form-control" min="15" max="180" value="60">
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addLessonModal')">Cancel</button>
                    <button type="submit" class="btn">Add Lesson</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Auto-save functionality
        let autoSaveTimer = null;
        let lastSaveTime = null;
        let saveIndicator = null;

        // Data storage - All sections are interconnected with real progress tracking
        let subjects = [
            { id: 1, name: 'Mathematics', emoji: 'ğŸ”¢', description: 'Algebra, Geometry, and Statistics', progress: 0, lessons: 0, planningData: {} },
            { id: 2, name: 'Science', emoji: 'ğŸ”¬', description: 'Chemistry, Physics, and Biology', progress: 0, lessons: 0, planningData: {} },
            { id: 3, name: 'English', emoji: 'ğŸ“', description: 'Literature, Writing, and Grammar', progress: 0, lessons: 0, planningData: {} },
            { id: 4, name: 'History', emoji: 'ğŸ›ï¸', description: 'World History and Geography', progress: 0, lessons: 0, planningData: {} },
            { id: 5, name: 'Art', emoji: 'ğŸ¨', description: 'Drawing, Painting, and Creative Expression', progress: 0, lessons: 0, planningData: {} },
            { id: 6, name: 'Music', emoji: 'ğŸµ', description: 'Theory, Practice, and Appreciation', progress: 0, lessons: 0, planningData: {} }
        ];

        let lessons = [
            // Lessons will be added dynamically and progress calculated from actual data
        ];

        // Auto-save functions
        function createSaveIndicator() {
            if (saveIndicator) return;
            
            saveIndicator = document.createElement('div');
            saveIndicator.id = 'saveIndicator';
            saveIndicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(16, 185, 129, 0.95);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.85rem;
                font-weight: 600;
                z-index: 1001;
                display: none;
                backdrop-filter: blur(10px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
            `;
            saveIndicator.innerHTML = 'ğŸ’¾ Saving...';
            document.body.appendChild(saveIndicator);
        }

        function showSaveIndicator(message = 'ğŸ’¾ Saving...', color = 'rgba(16, 185, 129, 0.95)') {
            if (!saveIndicator) createSaveIndicator();
            
            saveIndicator.innerHTML = message;
            saveIndicator.style.background = color;
            saveIndicator.style.display = 'block';
            
            setTimeout(() => {
                if (saveIndicator) {
                    saveIndicator.style.display = 'none';
                }
            }, 2000);
        }

        function autoSave() {
            const appData = {
                subjects: subjects,
                lessons: lessons,
                formData: {
                    learnerName: document.getElementById('learnerName')?.value || '',
                    teacherName: document.getElementById('teacherName')?.value || '',
                    globalCountryRegion: document.getElementById('globalCountryRegion')?.value || 'us',
                    globalCalendarSystem: document.getElementById('globalCalendarSystem')?.value || 'quarterly',
                    globalSchoolYearStart: document.getElementById('globalSchoolYearStart')?.value || '',
                    globalAcademicYear: document.getElementById('globalAcademicYear')?.value || '',
                    globalGradeLevel: document.getElementById('globalGradeLevel')?.value || '',
                    globalInterfaceLanguage: document.getElementById('globalInterfaceLanguage')?.value || 'en'
                },
                planningData: {
                    learningGoals: document.getElementById('learningGoals')?.value || '',
                    prerequisites: document.getElementById('prerequisites')?.value || '',
                    teachingNotes: document.getElementById('teachingNotes')?.value || '',
                    mappingInsights: document.getElementById('mappingInsights')?.value || '',
                    subjectSelect: document.getElementById('subjectSelect')?.value || '',
                    subjectFocus: document.getElementById('subjectFocus')?.value || 'unit'
                },
                tableData: {
                    monthlyPlan: getTableData('monthlyPlanTable'),
                    weeklyPlan: getTableData('weeklyPlanTable'),
                    schedule: getTableData('scheduleTable')
                },
                timestamp: new Date().toISOString(),
                version: '2.0'
            };
            
            try {
                localStorage.setItem('eduflow_autosave', JSON.stringify(appData));
                lastSaveTime = new Date();
                showSaveIndicator('âœ… Saved', 'rgba(16, 185, 129, 0.95)');
                console.log('Auto-saved at:', lastSaveTime.toLocaleTimeString());
            } catch (error) {
                console.error('Auto-save failed:', error);
                showSaveIndicator('âŒ Save Failed', 'rgba(239, 68, 68, 0.95)');
            }
        }

        function getTableData(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return [];
            
            const rows = table.querySelectorAll('tr');
            const data = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                cells.forEach(cell => {
                    const input = cell.querySelector('input, textarea, select');
                    rowData.push(input ? input.value : cell.textContent.trim());
                });
                if (rowData.length > 0) data.push(rowData);
            });
            
            return data;
        }

        function restoreTableData(tableId, data) {
            const table = document.getElementById(tableId);
            if (!table || !data || data.length === 0) return;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            data.forEach(rowData => {
                if (tableId === 'monthlyPlanTable') {
                    addMonthlyRow(rowData[0] || '', rowData[1] || '');
                    // Restore cell values
                    const lastRow = tbody.lastElementChild;
                    if (lastRow) {
                        const cells = lastRow.querySelectorAll('td');
                        cells.forEach((cell, index) => {
                            if (index < rowData.length) {
                                const input = cell.querySelector('input, textarea');
                                if (input && rowData[index]) {
                                    input.value = rowData[index];
                                }
                            }
                        });
                    }
                } else if (tableId === 'weeklyPlanTable') {
                    addSubjectRow(rowData[0] || '', rowData[1] || '');
                    // Restore cell values
                    const lastRow = tbody.lastElementChild;
                    if (lastRow) {
                        const cells = lastRow.querySelectorAll('td');
                        cells.forEach((cell, index) => {
                            if (index < rowData.length) {
                                const input = cell.querySelector('input, textarea');
                                if (input && rowData[index]) {
                                    input.value = rowData[index];
                                }
                            }
                        });
                    }
                } else if (tableId === 'scheduleTable') {
                    addTimeSlot(rowData[0] || '');
                    // Restore cell values
                    const lastRow = tbody.lastElementChild;
                    if (lastRow) {
                        const cells = lastRow.querySelectorAll('td');
                        cells.forEach((cell, index) => {
                            if (index < rowData.length) {
                                const input = cell.querySelector('input, textarea, select');
                                if (input && rowData[index]) {
                                    input.value = rowData[index];
                                }
                            }
                        });
                    }
                }
            });
        }

        function triggerAutoSave() {
            // Clear existing timer
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            // Show saving indicator immediately
            showSaveIndicator('ğŸ’¾ Saving...', 'rgba(59, 130, 246, 0.95)');
            
            // Set new timer for 1 second delay
            autoSaveTimer = setTimeout(() => {
                autoSave();
            }, 1000);
        }

        function loadAutoSavedData() {
            try {
                const savedData = localStorage.getItem('eduflow_autosave');
                if (!savedData) return false;
                
                const data = JSON.parse(savedData);
                
                // Restore subjects and lessons
                if (data.subjects) subjects = data.subjects;
                if (data.lessons) lessons = data.lessons;
                
                // Restore form data
                if (data.formData) {
                    Object.keys(data.formData).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && data.formData[key]) {
                            element.value = data.formData[key];
                        }
                    });
                }
                
                // Restore planning data
                if (data.planningData) {
                    Object.keys(data.planningData).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && data.planningData[key]) {
                            element.value = data.planningData[key];
                        }
                    });
                }
                
                // Restore table data
                if (data.tableData) {
                    setTimeout(() => {
                        if (data.tableData.monthlyPlan) restoreTableData('monthlyPlanTable', data.tableData.monthlyPlan);
                        if (data.tableData.weeklyPlan) restoreTableData('weeklyPlanTable', data.tableData.weeklyPlan);
                        if (data.tableData.schedule) restoreTableData('scheduleTable', data.tableData.schedule);
                    }, 500);
                }
                
                lastSaveTime = new Date(data.timestamp);
                console.log('Data restored from auto-save:', lastSaveTime.toLocaleTimeString());
                showSaveIndicator('âœ… Data Restored', 'rgba(16, 185, 129, 0.95)');
                return true;
            } catch (error) {
                console.error('Failed to load auto-saved data:', error);
                return false;
            }
        }

        function setupAutoSaveListeners() {
            // Only add listeners to table elements and planning fields
            // Avoid conflicts with name fields
            document.addEventListener('input', function(e) {
                if (e.target.matches('textarea') && 
                    e.target.closest('#monthlyPlanTable, #weeklyPlanTable, #scheduleTable')) {
                    triggerAutoSave();
                }
            });
            
            document.addEventListener('change', function(e) {
                if (e.target.matches('input, textarea, select') && 
                    !['learnerName', 'teacherName'].includes(e.target.id) &&
                    (e.target.closest('#monthlyPlanTable, #weeklyPlanTable, #scheduleTable') || 
                     ['learningGoals', 'prerequisites', 'teachingNotes', 'mappingInsights'].includes(e.target.id))) {
                    triggerAutoSave();
                }
            });
        }

        // Global curriculum data
        let globalCurricula = {
            'us': {
                name: 'ğŸ‡ºğŸ‡¸ United States',
                standards: 'Common Core State Standards',
                subjects: ['Mathematics', 'English Language Arts', 'Science', 'Social Studies', 'Physical Education', 'Arts'],
                gradeLevels: ['K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                calendarSystems: ['semester', 'quarterly', 'trimester'],
                standardSemesters: 2
            },
            'uk': {
                name: 'ğŸ‡¬ğŸ‡§ United Kingdom',
                standards: 'National Curriculum for England',
                subjects: ['Mathematics', 'English', 'Science', 'History', 'Geography', 'Art & Design', 'Music', 'PE', 'Computing'],
                gradeLevels: ['Reception', 'Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5', 'Year 6', 'Year 7', 'Year 8', 'Year 9', 'Year 10', 'Year 11'],
                calendarSystems: ['termly', 'half-termly', 'yearly'],
                standardSemesters: 3
            },
            'ca': {
                name: 'ğŸ‡¨ğŸ‡¦ Canada',
                standards: 'Provincial Curriculum Standards',
                subjects: ['Mathematics', 'Language Arts', 'Science', 'Social Studies', 'Health & Career Education', 'Arts Education', 'Physical Education'],
                gradeLevels: ['K', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'],
                calendarSystems: ['semester', 'quarterly', 'linear'],
                standardSemesters: 2
            },
            'au': {
                name: 'ğŸ‡¦ğŸ‡º Australia',
                standards: 'Australian Curriculum',
                subjects: ['Mathematics', 'English', 'Science', 'Humanities & Social Sciences', 'Health & Physical Education', 'The Arts', 'Technologies'],
                gradeLevels: ['Foundation', 'Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5', 'Year 6', 'Year 7', 'Year 8', 'Year 9', 'Year 10', 'Year 11', 'Year 12'],
                calendarSystems: ['termly', 'semester', 'yearly'],
                standardSemesters: 4
            },
            'nz': {
                name: 'ğŸ‡³ğŸ‡¿ New Zealand',
                standards: 'New Zealand Curriculum',
                subjects: ['Mathematics', 'English', 'Science', 'Social Sciences', 'Health & Physical Education', 'The Arts', 'Technology'],
                gradeLevels: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5', 'Year 6', 'Year 7', 'Year 8', 'Year 9', 'Year 10', 'Year 11', 'Year 12', 'Year 13'],
                calendarSystems: ['termly', 'semester', 'yearly'],
                standardSemesters: 4
            },
            'sg': {
                name: 'ğŸ‡¸ğŸ‡¬ Singapore',
                standards: 'Singapore Curriculum',
                subjects: ['Mathematics', 'English Language', 'Science', 'Social Studies', 'Mother Tongue', 'Physical Education', 'Arts'],
                gradeLevels: ['Primary 1', 'Primary 2', 'Primary 3', 'Primary 4', 'Primary 5', 'Primary 6', 'Secondary 1', 'Secondary 2', 'Secondary 3', 'Secondary 4'],
                calendarSystems: ['semester', 'termly', 'yearly'],
                standardSemesters: 2
            },
            'in': {
                name: 'ğŸ‡®ğŸ‡³ India',
                standards: 'NCERT/CBSE Curriculum',
                subjects: ['Mathematics', 'English', 'Hindi', 'Science', 'Social Science', 'Physical Education', 'Arts'],
                gradeLevels: ['Class 1', 'Class 2', 'Class 3', 'Class 4', 'Class 5', 'Class 6', 'Class 7', 'Class 8', 'Class 9', 'Class 10', 'Class 11', 'Class 12'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'de': {
                name: 'ğŸ‡©ğŸ‡ª Germany',
                standards: 'German Education Standards',
                subjects: ['Mathematik', 'Deutsch', 'Sachunterricht', 'Englisch', 'Geschichte', 'Erdkunde', 'Kunst', 'Musik', 'Sport'],
                gradeLevels: ['Klasse 1', 'Klasse 2', 'Klasse 3', 'Klasse 4', 'Klasse 5', 'Klasse 6', 'Klasse 7', 'Klasse 8', 'Klasse 9', 'Klasse 10', 'Klasse 11', 'Klasse 12'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'fr': {
                name: 'ğŸ‡«ğŸ‡· France',
                standards: 'French National Education',
                subjects: ['MathÃ©matiques', 'FranÃ§ais', 'Sciences', 'Histoire-GÃ©ographie', 'Ã‰ducation Physique', 'Arts Plastiques', 'Musique'],
                gradeLevels: ['CP', 'CE1', 'CE2', 'CM1', 'CM2', '6Ã¨me', '5Ã¨me', '4Ã¨me', '3Ã¨me', '2nde', '1Ã¨re', 'Terminale'],
                calendarSystems: ['trimester', 'semester', 'yearly'],
                standardSemesters: 3
            },
            'jp': {
                name: 'ğŸ‡¯ğŸ‡µ Japan',
                standards: 'Japanese Course of Study',
                subjects: ['ç®—æ•°/æ•°å­¦', 'å›½èª', 'ç†ç§‘', 'ç¤¾ä¼š', 'ä½“è‚²', 'éŸ³æ¥½', 'å›³ç”»å·¥ä½œ/ç¾è¡“', 'è‹±èª'],
                gradeLevels: ['å°1', 'å°2', 'å°3', 'å°4', 'å°5', 'å°6', 'ä¸­1', 'ä¸­2', 'ä¸­3', 'é«˜1', 'é«˜2', 'é«˜3'],
                calendarSystems: ['trimester', 'semester', 'yearly'],
                standardSemesters: 3
            },
            'cn': {
                name: 'ğŸ‡¨ğŸ‡³ China',
                standards: 'Chinese National Curriculum',
                subjects: ['æ•°å­¦', 'è¯­æ–‡', 'è‹±è¯­', 'ç§‘å­¦', 'å†å²', 'åœ°ç†', 'ä½“è‚²', 'ç¾æœ¯', 'éŸ³ä¹'],
                gradeLevels: ['ä¸€å¹´çº§', 'äºŒå¹´çº§', 'ä¸‰å¹´çº§', 'å››å¹´çº§', 'äº”å¹´çº§', 'å…­å¹´çº§', 'ä¸ƒå¹´çº§', 'å…«å¹´çº§', 'ä¹å¹´çº§', 'é«˜ä¸€', 'é«˜äºŒ', 'é«˜ä¸‰'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'kr': {
                name: 'ğŸ‡°ğŸ‡· South Korea',
                standards: 'Korean National Curriculum',
                subjects: ['ìˆ˜í•™', 'êµ­ì–´', 'ì˜ì–´', 'ê³¼í•™', 'ì‚¬íšŒ', 'ì²´ìœ¡', 'ìŒì•…', 'ë¯¸ìˆ '],
                gradeLevels: ['ì´ˆ1', 'ì´ˆ2', 'ì´ˆ3', 'ì´ˆ4', 'ì´ˆ5', 'ì´ˆ6', 'ì¤‘1', 'ì¤‘2', 'ì¤‘3', 'ê³ 1', 'ê³ 2', 'ê³ 3'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'th': {
                name: 'ğŸ‡¹ğŸ‡­ Thailand',
                standards: 'Thai Basic Education Core Curriculum',
                subjects: ['à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ', 'à¸ à¸²à¸©à¸²à¹„à¸—à¸¢', 'à¸ à¸²à¸©à¸²à¸­à¸±à¸‡à¸à¸¤à¸©', 'à¸§à¸´à¸—à¸¢à¸²à¸¨à¸²à¸ªà¸•à¸£à¹Œ', 'à¸ªà¸±à¸‡à¸„à¸¡à¸¨à¸¶à¸à¸©à¸²', 'à¸à¸¥à¸¨à¸¶à¸à¸©à¸²', 'à¸¨à¸´à¸¥à¸›à¸°'],
                gradeLevels: ['à¸›.1', 'à¸›.2', 'à¸›.3', 'à¸›.4', 'à¸›.5', 'à¸›.6', 'à¸¡.1', 'à¸¡.2', 'à¸¡.3', 'à¸¡.4', 'à¸¡.5', 'à¸¡.6'],
                calendarSystems: ['semester', 'trimester', 'yearly'],
                standardSemesters: 2
            },
            'my': {
                name: 'ğŸ‡²ğŸ‡¾ Malaysia',
                standards: 'Malaysian National Curriculum',
                subjects: ['Matematik', 'Bahasa Malaysia', 'English', 'Science', 'Sejarah', 'Geografi', 'Pendidikan Jasmani', 'Seni'],
                gradeLevels: ['Tahun 1', 'Tahun 2', 'Tahun 3', 'Tahun 4', 'Tahun 5', 'Tahun 6', 'Tingkatan 1', 'Tingkatan 2', 'Tingkatan 3', 'Tingkatan 4', 'Tingkatan 5'],
                calendarSystems: ['semester', 'termly', 'yearly'],
                standardSemesters: 2
            },
            'ph': {
                name: 'ğŸ‡µğŸ‡­ Philippines',
                standards: 'K to 12 Basic Education Curriculum',
                subjects: ['Mathematics', 'Filipino', 'English', 'Science', 'Araling Panlipunan', 'MAPEH', 'TLE'],
                gradeLevels: ['Kinder', 'Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6', 'Grade 7', 'Grade 8', 'Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'],
                calendarSystems: ['quarterly', 'semester', 'yearly'],
                standardSemesters: 4
            },
            'id': {
                name: 'ğŸ‡®ğŸ‡© Indonesia',
                standards: 'Indonesian National Curriculum',
                subjects: ['Matematika', 'Bahasa Indonesia', 'Bahasa Inggris', 'IPA', 'IPS', 'Pendidikan Jasmani', 'Seni Budaya'],
                gradeLevels: ['Kelas 1', 'Kelas 2', 'Kelas 3', 'Kelas 4', 'Kelas 5', 'Kelas 6', 'Kelas 7', 'Kelas 8', 'Kelas 9', 'Kelas 10', 'Kelas 11', 'Kelas 12'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'ae': {
                name: 'ğŸ‡¦ğŸ‡ª UAE',
                standards: 'UAE National Curriculum',
                subjects: ['Mathematics', 'Arabic', 'English', 'Science', 'Social Studies', 'Islamic Studies', 'Physical Education', 'Arts'],
                gradeLevels: ['KG1', 'KG2', 'Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6', 'Grade 7', 'Grade 8', 'Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'],
                calendarSystems: ['semester', 'trimester', 'yearly'],
                standardSemesters: 2
            },
            'sa': {
                name: 'ğŸ‡¸ğŸ‡¦ Saudi Arabia',
                standards: 'Saudi National Curriculum',
                subjects: ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', 'Ø§Ù„Ø¹Ù„ÙˆÙ…', 'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©', 'Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©', 'Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©', 'Ø§Ù„ÙÙ†ÙˆÙ†'],
                gradeLevels: ['Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹', 'Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³', 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³', 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹', 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†', 'Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹', 'Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±', 'Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±', 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            },
            'qa': {
                name: 'ğŸ‡¶ğŸ‡¦ Qatar',
                standards: 'Qatar National Curriculum',
                subjects: ['Mathematics', 'Arabic', 'English', 'Science', 'Social Studies', 'Islamic Studies', 'Physical Education', 'Arts'],
                gradeLevels: ['Foundation', 'Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6', 'Grade 7', 'Grade 8', 'Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'],
                calendarSystems: ['semester', 'trimester', 'yearly'],
                standardSemesters: 2
            },
            'tr': {
                name: 'ğŸ‡¹ğŸ‡· Turkey',
                standards: 'Turkish National Curriculum',
                subjects: ['Matematik', 'TÃ¼rkÃ§e', 'Ä°ngilizce', 'Fen Bilimleri', 'Sosyal Bilgiler', 'Beden EÄŸitimi', 'Sanat'],
                gradeLevels: ['1. SÄ±nÄ±f', '2. SÄ±nÄ±f', '3. SÄ±nÄ±f', '4. SÄ±nÄ±f', '5. SÄ±nÄ±f', '6. SÄ±nÄ±f', '7. SÄ±nÄ±f', '8. SÄ±nÄ±f', '9. SÄ±nÄ±f', '10. SÄ±nÄ±f', '11. SÄ±nÄ±f', '12. SÄ±nÄ±f'],
                calendarSystems: ['semester', 'quarterly', 'yearly'],
                standardSemesters: 2
            }
        };

        // Calendar system configurations
        let calendarConfigs = {
            'quarterly': { periods: 4, name: 'Quarter', duration: '3 months' },
            'semester': { periods: 2, name: 'Semester', duration: '6 months' },
            'trimester': { periods: 3, name: 'Trimester', duration: '4 months' },
            'termly': { periods: 3, name: 'Term', duration: '4 months' },
            'half-termly': { periods: 6, name: 'Half-Term', duration: '2 months' },
            'monthly': { periods: 12, name: 'Month', duration: '1 month' },
            'linear': { periods: 1, name: 'Full Year', duration: '10 months' },
            'yearly': { periods: 1, name: 'Academic Year', duration: '10 months' }
        };

        // Navigation functions
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected view
            document.getElementById(viewName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load view-specific content
            if (viewName === 'subjects') {
                loadSubjects();
            } else if (viewName === 'planner') {
                initializePlannerTables();
                populateLessonSubjects();
            } else if (viewName === 'schedule') {
                loadScheduleTemplate();
            } else if (viewName === 'progress') {
                loadProgressCharts();
                loadMilestones();
            } else if (viewName === 'overview') {
                updateOverviewStats();
            }
        }

        // Planner view navigation
        function showPlannerView(viewName) {
            // Hide all planner views
            document.querySelectorAll('.planner-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Remove active class from all planner tabs
            document.querySelectorAll('.planner-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected planner view
            document.getElementById(viewName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Initialize tables based on view
            if (viewName === 'subject-wise') {
                initializeMonthlyPlanTable();
            } else if (viewName === 'period-wise') {
                initializeWeeklyPlanTable();
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Subject management
        function loadSubjects() {
            const grid = document.getElementById('subjectsGrid');
            grid.innerHTML = '';
            
            subjects.forEach(subject => {
                const card = document.createElement('div');
                card.className = 'subject-card';
                card.innerHTML = `
                    <h3>${subject.emoji} ${subject.name}</h3>
                    <p>${subject.description}</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${subject.progress}%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                        <small style="color: #6b7280;">${subject.progress}% Complete â€¢ ${subject.lessons} lessons</small>
                        <button class="btn btn-danger" onclick="deleteSubject(${subject.id})" style="padding: 6px 12px; font-size: 0.8rem;">
                            ğŸ—‘ï¸ Delete
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function addSubject(event) {
            event.preventDefault();
            
            const name = document.getElementById('subjectName').value;
            const emoji = document.getElementById('subjectEmoji').value || 'ğŸ“š';
            const description = document.getElementById('subjectDescription').value;
            
            const newSubject = {
                id: Date.now(),
                name,
                emoji,
                description,
                progress: 0,
                lessons: 0,
                planningData: {}
            };
            
            subjects.push(newSubject);
            closeModal('addSubjectModal');
            
            // Reset form
            document.getElementById('subjectName').value = '';
            document.getElementById('subjectEmoji').value = '';
            document.getElementById('subjectDescription').value = '';
            
            // Update all interconnected sections
            updateAllSections();
        }

        // Update all sections when data changes
        function updateAllSections() {
            updateOverviewStats();
            if (document.getElementById('subjects').classList.contains('active')) {
                loadSubjects();
            }
            populateLessonSubjects();
            updateSubjectDropdown();
            syncWeeklyPlanningWithSubjects();
        }

        // Generate subject-specific content for ANY subject (fully dynamic)
        function getSubjectSpecificContent(subjectName, emoji) {
            const name = subjectName.toLowerCase();
            
            // Subject-specific learning goals and content
            const subjectMappings = {
                // Core subjects
                'mathematics': {
                    unitGoals: 'â€¢ Develop problem-solving and analytical thinking skills\nâ€¢ Master mathematical concepts and procedures\nâ€¢ Apply math to real-world situations',
                    quarterGoals: 'â€¢ Build strong foundation in mathematical reasoning\nâ€¢ Complete major mathematical skill areas\nâ€¢ Prepare for advanced mathematical concepts',
                    termGoals: 'â€¢ Achieve mathematical fluency and confidence\nâ€¢ Connect mathematical concepts across topics\nâ€¢ Develop mathematical communication skills',
                    semesterGoals: 'â€¢ Master grade-appropriate mathematical standards\nâ€¢ Demonstrate mathematical proficiency through assessments\nâ€¢ Apply mathematical thinking to complex problems',
                    yearGoals: 'â€¢ Achieve mathematical proficiency for grade level\nâ€¢ Prepare for next level mathematical concepts\nâ€¢ Develop lifelong mathematical thinking skills',
                    prerequisites: 'â€¢ Basic arithmetic operations\nâ€¢ Number sense and place value understanding\nâ€¢ Problem-solving strategies',
                    teaching: 'â€¢ Use manipulatives and visual aids\nâ€¢ Encourage multiple solution methods\nâ€¢ Connect to real-world applications\nâ€¢ Practice computational fluency regularly',
                    connections: 'â€¢ Science: Data analysis and measurement\nâ€¢ Art: Geometric patterns and symmetry\nâ€¢ Social Studies: Statistics and graphs\nâ€¢ Daily Life: Money, time, and measurement'
                },
                'science': {
                    unitGoals: 'â€¢ Develop scientific inquiry and investigation skills\nâ€¢ Understand key scientific concepts and principles\nâ€¢ Practice scientific method and observation',
                    quarterGoals: 'â€¢ Build scientific knowledge through hands-on exploration\nâ€¢ Develop critical thinking about natural phenomena\nâ€¢ Connect scientific concepts to everyday life',
                    termGoals: 'â€¢ Master scientific processes and procedures\nâ€¢ Understand interconnections in natural systems\nâ€¢ Develop scientific communication skills',
                    semesterGoals: 'â€¢ Achieve scientific literacy and understanding\nâ€¢ Demonstrate scientific thinking through investigations\nâ€¢ Apply scientific knowledge to solve problems',
                    yearGoals: 'â€¢ Master grade-level scientific concepts\nâ€¢ Develop scientific reasoning and inquiry skills\nâ€¢ Prepare for advanced scientific study',
                    prerequisites: 'â€¢ Basic observation and measurement skills\nâ€¢ Understanding of scientific method\nâ€¢ Safety procedures and lab skills',
                    teaching: 'â€¢ Use hands-on experiments and investigations\nâ€¢ Encourage questioning and hypothesis formation\nâ€¢ Connect to current events and technology\nâ€¢ Emphasize safety and proper procedures',
                    connections: 'â€¢ Mathematics: Data collection and analysis\nâ€¢ English: Scientific writing and vocabulary\nâ€¢ Social Studies: Environmental and health issues\nâ€¢ Technology: Scientific tools and instruments'
                },
                'english': {
                    unitGoals: 'â€¢ Develop reading comprehension and fluency\nâ€¢ Improve writing skills and expression\nâ€¢ Build vocabulary and language understanding',
                    quarterGoals: 'â€¢ Master reading strategies and comprehension\nâ€¢ Develop strong writing and communication skills\nâ€¢ Expand vocabulary and language usage',
                    termGoals: 'â€¢ Achieve reading and writing proficiency\nâ€¢ Develop critical thinking about texts\nâ€¢ Master grammar and language conventions',
                    semesterGoals: 'â€¢ Demonstrate grade-level reading and writing skills\nâ€¢ Analyze and interpret various text types\nâ€¢ Communicate effectively in multiple formats',
                    yearGoals: 'â€¢ Master grade-level literacy standards\nâ€¢ Develop lifelong reading and writing habits\nâ€¢ Prepare for advanced language arts study',
                    prerequisites: 'â€¢ Basic phonics and decoding skills\nâ€¢ Sight word recognition\nâ€¢ Basic writing and spelling abilities',
                    teaching: 'â€¢ Use diverse texts and genres\nâ€¢ Encourage daily reading and writing\nâ€¢ Teach explicit reading strategies\nâ€¢ Provide regular feedback on writing',
                    connections: 'â€¢ Social Studies: Historical texts and documents\nâ€¢ Science: Scientific writing and research\nâ€¢ Art: Creative writing and storytelling\nâ€¢ All subjects: Reading comprehension and communication'
                },
                'history': {
                    unitGoals: 'â€¢ Understand historical events and their significance\nâ€¢ Develop chronological thinking skills\nâ€¢ Analyze cause and effect relationships',
                    quarterGoals: 'â€¢ Build knowledge of historical periods and cultures\nâ€¢ Develop critical thinking about historical sources\nâ€¢ Connect past events to present situations',
                    termGoals: 'â€¢ Master historical thinking and analysis skills\nâ€¢ Understand diverse perspectives in history\nâ€¢ Develop research and inquiry abilities',
                    semesterGoals: 'â€¢ Demonstrate understanding of historical concepts\nâ€¢ Analyze primary and secondary sources\nâ€¢ Make connections between past and present',
                    yearGoals: 'â€¢ Master grade-level historical knowledge\nâ€¢ Develop historical thinking and reasoning\nâ€¢ Understand civic responsibilities and citizenship',
                    prerequisites: 'â€¢ Basic understanding of time and chronology\nâ€¢ Map and geography skills\nâ€¢ Reading comprehension abilities',
                    teaching: 'â€¢ Use primary sources and artifacts\nâ€¢ Encourage multiple perspectives\nâ€¢ Connect to current events\nâ€¢ Use timelines and graphic organizers',
                    connections: 'â€¢ English: Historical literature and documents\nâ€¢ Geography: Maps and spatial understanding\nâ€¢ Civics: Government and citizenship\nâ€¢ Art: Historical art and culture'
                }
            };
            
            // Check for exact matches first
            if (subjectMappings[name]) {
                return subjectMappings[name];
            }
            
            // Check for partial matches or related subjects
            for (const [key, content] of Object.entries(subjectMappings)) {
                if (name.includes(key) || key.includes(name)) {
                    return content;
                }
            }
            
            // Generic content for any custom subject
            return {
                unitGoals: `â€¢ Develop foundational skills in ${subjectName}\nâ€¢ Build understanding of key concepts\nâ€¢ Apply learning to practical situations`,
                quarterGoals: `â€¢ Master essential ${subjectName} knowledge and skills\nâ€¢ Develop critical thinking in this subject area\nâ€¢ Connect learning to broader educational goals`,
                termGoals: `â€¢ Achieve proficiency in ${subjectName} concepts\nâ€¢ Develop deeper understanding and application\nâ€¢ Build confidence and competence in subject area`,
                semesterGoals: `â€¢ Demonstrate mastery of ${subjectName} standards\nâ€¢ Apply knowledge to complex problems and projects\nâ€¢ Prepare for advanced study in this area`,
                yearGoals: `â€¢ Master all grade-level ${subjectName} objectives\nâ€¢ Develop lifelong interest and skills\nâ€¢ Prepare for next level of study`,
                prerequisites: `â€¢ Basic foundational knowledge in ${subjectName}\nâ€¢ Appropriate grade-level skills\nâ€¢ Interest and motivation to learn`,
                teaching: `â€¢ Use engaging and interactive methods\nâ€¢ Provide hands-on learning opportunities\nâ€¢ Connect to student interests and experiences\nâ€¢ Assess progress regularly and adjust instruction`,
                connections: `â€¢ Connect to other academic subjects\nâ€¢ Relate to real-world applications\nâ€¢ Build interdisciplinary understanding\nâ€¢ Support overall educational development`
            };
        }

        // Update subject dropdown in planner
        function updateSubjectDropdown() {
            const select = document.getElementById('subjectSelect');
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Subject</option>';
            
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.emoji} ${subject.name}`;
                select.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Update subject title when selection changes
        function updateSubjectTitle() {
            const subjectId = document.getElementById('subjectSelect').value;
            const titleElement = document.getElementById('monthlyPlanningTitle');
            
            if (!titleElement) return;
            
            if (subjectId) {
                const subject = subjects.find(s => s.id == subjectId);
                if (subject) {
                    titleElement.textContent = `${subject.emoji} ${subject.name} Monthly Curriculum Planning`;
                } else {
                    titleElement.textContent = 'Monthly Curriculum Planning';
                }
            } else {
                titleElement.textContent = 'Monthly Curriculum Planning';
            }
        }

        // Update calendar table based on global settings
        function updateCalendarTable() {
            const calendarSystem = document.getElementById('globalCalendarSystem').value;
            const config = calendarConfigs[calendarSystem];
            
            if (!config) return;
            
            // Clear existing table
            const tableBody = document.getElementById('monthlyPlanTable');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // Update weekly table headers based on calendar system
            updateWeeklyTableHeaders(calendarSystem);
            
            // Get school year start month from global settings
            const schoolYearStart = document.getElementById('globalSchoolYearStart').value;
            let startMonth = 8; // Default to September (month 8)
            if (schoolYearStart) {
                startMonth = parseInt(schoolYearStart.split('-')[1]) - 1; // Convert to 0-based month
            }
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Add rows based on calendar system with detailed month breakdowns
            for (let i = 1; i <= config.periods; i++) {
                let periodName = '';
                let months = '';
                
                if (calendarSystem === 'quarterly') {
                    periodName = `Quarter ${i}`;
                    // Calculate months for each quarter based on start month
                    const quarterStartMonth = (startMonth + (i - 1) * 3) % 12;
                    const month1 = monthNames[quarterStartMonth];
                    const month2 = monthNames[(quarterStartMonth + 1) % 12];
                    const month3 = monthNames[(quarterStartMonth + 2) % 12];
                    months = `${month1}, ${month2}, ${month3}`;
                } else if (calendarSystem === 'semester') {
                    periodName = `Semester ${i}`;
                    if (i === 1) {
                        const semesterStartMonth = startMonth;
                        const monthsInSemester = [];
                        for (let j = 0; j < 6; j++) {
                            monthsInSemester.push(monthNames[(semesterStartMonth + j) % 12]);
                        }
                        months = monthsInSemester.join(', ');
                    } else {
                        const semesterStartMonth = (startMonth + 6) % 12;
                        const monthsInSemester = [];
                        for (let j = 0; j < 6; j++) {
                            monthsInSemester.push(monthNames[(semesterStartMonth + j) % 12]);
                        }
                        months = monthsInSemester.join(', ');
                    }
                } else if (calendarSystem === 'trimester') {
                    periodName = `Trimester ${i}`;
                    const trimesterStartMonth = (startMonth + (i - 1) * 4) % 12;
                    const month1 = monthNames[trimesterStartMonth];
                    const month2 = monthNames[(trimesterStartMonth + 1) % 12];
                    const month3 = monthNames[(trimesterStartMonth + 2) % 12];
                    const month4 = monthNames[(trimesterStartMonth + 3) % 12];
                    months = `${month1}, ${month2}, ${month3}, ${month4}`;
                } else if (calendarSystem === 'termly') {
                    // UK Term system: Autumn, Spring, Summer
                    const termNames = ['Autumn Term', 'Spring Term', 'Summer Term'];
                    const termMonths = [
                        ['September', 'October', 'November', 'December'],
                        ['January', 'February', 'March', 'April'],
                        ['April', 'May', 'June', 'July']
                    ];
                    periodName = termNames[i - 1];
                    months = termMonths[i - 1].join(', ');
                } else if (calendarSystem === 'monthly') {
                    const monthIndex = (startMonth + i - 1) % 12;
                    periodName = monthNames[monthIndex];
                    months = monthNames[monthIndex];
                } else if (calendarSystem === 'half-termly') {
                    // UK Half-term system: 6 periods
                    const halfTermNames = ['Autumn 1', 'Autumn 2', 'Spring 1', 'Spring 2', 'Summer 1', 'Summer 2'];
                    const halfTermMonths = [
                        ['September', 'October'],
                        ['November', 'December'],
                        ['January', 'February'],
                        ['March', 'April'],
                        ['May', 'June'],
                        ['July']
                    ];
                    periodName = halfTermNames[i - 1];
                    months = halfTermMonths[i - 1].join(', ');
                }
                
                addMonthlyRow(periodName, months);
            }
        }

        // Update weekly table headers based on calendar system
        function updateWeeklyTableHeaders(calendarSystem) {
            const config = calendarConfigs[calendarSystem];
            if (!config) return;
            
            // Get current country to determine weeks per period
            const currentCountry = document.getElementById('globalCountryRegion')?.value || 'us';
            
            // Calculate weeks per period based on calendar system and country
            let weeksPerPeriod;
            switch(calendarSystem) {
                case 'quarterly':
                    // Philippines uses 10 weeks per quarter, others use 9-12
                    weeksPerPeriod = currentCountry === 'ph' ? 10 : 9;
                    break;
                case 'semester':
                    weeksPerPeriod = 18; // 18 weeks per semester
                    break;
                case 'trimester':
                    weeksPerPeriod = 12; // 12 weeks per trimester
                    break;
                case 'termly':
                    weeksPerPeriod = 12; // 12 weeks per term (UK system)
                    break;
                case 'monthly':
                    weeksPerPeriod = 4; // 4 weeks per month
                    break;
                default:
                    weeksPerPeriod = 12;
            }
            
            // Limit to maximum 12 columns for display
            const displayWeeks = Math.min(weeksPerPeriod, 12);
            
            // Update header labels and visibility
            for (let i = 1; i <= 12; i++) {
                const header = document.getElementById(`week${i}Header`);
                if (header) {
                    if (i <= displayWeeks) {
                        header.textContent = `Week ${i}`;
                        header.style.display = 'table-cell';
                    } else {
                        header.style.display = 'none';
                    }
                }
            }
            
            // Update existing table rows to show/hide cells
            const tableBody = document.getElementById('weeklyPlanTable');
            if (tableBody) {
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // Skip first 2 cells (subject and textbook), then handle week cells
                    for (let i = 2; i < cells.length && i < 14; i++) {
                        const weekIndex = i - 1; // Week 1 starts at index 2, so week number is i-1
                        if (weekIndex <= displayWeeks) {
                            cells[i].style.display = 'table-cell';
                        } else {
                            cells[i].style.display = 'none';
                        }
                    }
                });
            }
        }

        // Global calendar configuration functions
        function updateGlobalCountrySettings() {
            const country = document.getElementById('globalCountryRegion').value;
            const curriculum = globalCurricula[country];
            
            if (!curriculum) return;
            
            // Update global calendar system options based on country
            const calendarSelect = document.getElementById('globalCalendarSystem');
            calendarSelect.innerHTML = '';
            
            curriculum.calendarSystems.forEach(system => {
                const config = calendarConfigs[system];
                if (config) {
                    const option = document.createElement('option');
                    option.value = system;
                    option.textContent = `${config.name} (${config.periods} periods - ${config.duration})`;
                    calendarSelect.appendChild(option);
                }
            });
            
            // Set default to quarterly for Philippines
            if (country === 'ph') {
                calendarSelect.value = 'quarterly';
                // Trigger the change event to update everything
                setTimeout(() => {
                    calendarSelect.dispatchEvent(new Event('change'));
                }, 100);
            }
            
            // Update period dropdown based on first calendar system
            if (curriculum.calendarSystems.length > 0) {
                const selectedSystem = country === 'ph' ? 'quarterly' : curriculum.calendarSystems[0];
                updateGlobalPeriodDropdown(selectedSystem);
            }
            
            // Show global curriculum info
            showGlobalCurriculumInfo(curriculum);
            
            // Update calendar table with new system
            updateCalendarTable();
            
            // Sync to individual view dropdowns
            syncToIndividualViews();
        }

        function updateAcademicYearFromStart() {
            const schoolYearStart = document.getElementById('globalSchoolYearStart').value;
            const academicYearSelect = document.getElementById('globalAcademicYear');
            
            if (!schoolYearStart) return;
            
            const startYear = parseInt(schoolYearStart.split('-')[0]);
            const startMonth = parseInt(schoolYearStart.split('-')[1]);
            
            // Academic year spans two calendar years if it starts in August or later
            let academicYear;
            if (startMonth >= 8) {
                academicYear = `${startYear}-${startYear + 1}`;
            } else {
                academicYear = `${startYear - 1}-${startYear}`;
            }
            
            // Update the academic year dropdown
            academicYearSelect.innerHTML = '';
            for (let i = -1; i <= 2; i++) {
                const year = startYear + i;
                const yearOption = startMonth >= 8 ? `${year}-${year + 1}` : `${year - 1}-${year}`;
                const option = document.createElement('option');
                option.value = yearOption;
                option.textContent = yearOption;
                if (yearOption === academicYear) {
                    option.selected = true;
                }
                academicYearSelect.appendChild(option);
            }
            
            // Update header info
            updateHeaderInfo();
        }

        function updateGlobalCalendarSystem() {
            const calendarSystem = document.getElementById('globalCalendarSystem').value;
            const config = calendarConfigs[calendarSystem];
            
            if (!config) return;
            
            // Update period dropdown
            updateGlobalPeriodDropdown(calendarSystem);
            
            // Update calendar table
            updateCalendarTable();
            
            // Update academic year based on school year start
            updateAcademicYearFromStart();
            
            // Sync to individual views
            syncToIndividualViews();
        }

        function updateGlobalPeriodDropdown(calendarSystem) {
            const config = calendarConfigs[calendarSystem];
            const periodSelect = document.getElementById('periodSelect');
            const periodLabel = document.getElementById('periodLabel');
            
            if (!config || !periodSelect) return;
            
            periodLabel.textContent = `ğŸ“… Select ${config.name} to Plan`;
            periodSelect.innerHTML = '';
            
            for (let i = 1; i <= config.periods; i++) {
                const option = document.createElement('option');
                option.value = `p${i}`;
                option.textContent = `${config.name} ${i}`;
                periodSelect.appendChild(option);
            }
        }

        function showGlobalCurriculumInfo(curriculum) {
            const infoDiv = document.getElementById('globalCurriculumInfo');
            const standardsP = document.getElementById('globalCurriculumStandards');
            const termNote = document.getElementById('termBasedNote');
            
            if (infoDiv && standardsP) {
                standardsP.textContent = `${curriculum.name} - ${curriculum.standards}`;
                infoDiv.style.display = 'block';
            }
            
            // Show note for term-based countries
            if (termNote) {
                const country = document.getElementById('globalCountryRegion').value;
                const isTermBased = ['uk', 'au', 'nz'].includes(country);
                termNote.style.display = isTermBased ? 'block' : 'none';
            }
        }

        function syncToIndividualViews() {
            // Sync global settings to individual view elements
            const globalCountry = document.getElementById('globalCountryRegion').value;
            const globalCalendar = document.getElementById('globalCalendarSystem').value;
            const globalYear = document.getElementById('globalAcademicYear').value;
            const globalGrade = document.getElementById('globalGradeLevel').value;
            const globalYearStart = document.getElementById('globalSchoolYearStart').value;
            const globalInterfaceLanguage = document.getElementById('globalInterfaceLanguage').value;
            
            // Update subject-wise view elements if they exist
            const gradeLevel = document.getElementById('gradeLevel');
            const schoolYearStart = document.getElementById('schoolYearStart');
            const calendarSystem = document.getElementById('calendarSystem');
            
            if (gradeLevel) gradeLevel.value = globalGrade;
            if (schoolYearStart) schoolYearStart.value = globalYearStart;
            if (calendarSystem) calendarSystem.value = globalCalendar;
            
            // Update period-wise view elements if they exist
            const countryRegion = document.getElementById('countryRegion');
            const academicYear = document.getElementById('academicYear');
            
            if (countryRegion) countryRegion.value = globalCountry;
            if (academicYear) academicYear.value = globalYear;
        }

        // Update country-based options (legacy function for compatibility)
        function updateCountryBasedOptions() {
            // This function is now handled by the global configuration
            console.log('Using global country configuration');
        }

        // Update period dropdown based on calendar system
        function updatePeriodDropdown(calendarSystem) {
            const config = calendarConfigs[calendarSystem];
            const periodLabel = document.getElementById('periodLabel');
            const quarterSelect = document.getElementById('quarterSelect');
            
            if (!config) return;
            
            periodLabel.textContent = config.name;
            quarterSelect.innerHTML = '';
            
            for (let i = 1; i <= config.periods; i++) {
                const option = document.createElement('option');
                option.value = `p${i}`;
                option.textContent = `${config.name} ${i}`;
                quarterSelect.appendChild(option);
            }
        }

        // Show curriculum information
        function showCurriculumInfo(curriculum) {
            const infoDiv = document.getElementById('curriculumInfo');
            const standardsP = document.getElementById('curriculumStandards');
            
            if (infoDiv && standardsP) {
                standardsP.textContent = `${curriculum.name} - ${curriculum.standards}`;
                infoDiv.style.display = 'block';
            }
            
            console.log(`Using ${curriculum.name} curriculum with ${curriculum.standards}`);
        }

        function deleteSubject(id) {
            if (confirm('Are you sure you want to delete this subject? This will also remove all associated lessons.')) {
                // Remove subject
                subjects = subjects.filter(subject => subject.id !== id);
                
                // Remove associated lessons
                lessons = lessons.filter(lesson => lesson.subjectId !== id);
                
                // Update all interconnected sections
                updateAllSections();
            }
        }

        // Lesson management
        function populateLessonSubjects() {
            const select = document.getElementById('lessonSubject');
            select.innerHTML = '<option value="">Select a subject</option>';
            
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.emoji} ${subject.name}`;
                select.appendChild(option);
            });
        }

        function addLesson(event) {
            event.preventDefault();
            
            const subjectId = parseInt(document.getElementById('lessonSubject').value);
            const title = document.getElementById('lessonTitle').value;
            const date = document.getElementById('lessonDate').value;
            const duration = parseInt(document.getElementById('lessonDuration').value);
            
            const newLesson = {
                id: Date.now(),
                subjectId,
                title,
                date,
                duration,
                status: 'not-started'
            };
            
            lessons.push(newLesson);
            
            // Update subject lesson count and progress
            const subject = subjects.find(s => s.id === subjectId);
            if (subject) {
                subject.lessons += 1;
                // Recalculate progress based on completed lessons
                const subjectLessons = lessons.filter(l => l.subjectId === subjectId);
                const completedLessons = subjectLessons.filter(l => l.status === 'completed');
                subject.progress = subjectLessons.length > 0 ? Math.round((completedLessons.length / subjectLessons.length) * 100) : 0;
            }
            
            closeModal('addLessonModal');
            
            // Reset form
            document.getElementById('lessonSubject').value = '';
            document.getElementById('lessonTitle').value = '';
            document.getElementById('lessonDate').value = '';
            document.getElementById('lessonDuration').value = '60';
            
            // Update all interconnected sections
            updateAllSections();
        }

        // Update lesson status and recalculate progress
        function updateLessonStatus(lessonId, newStatus) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (lesson) {
                lesson.status = newStatus;
                
                // Update subject progress
                const subject = subjects.find(s => s.id === lesson.subjectId);
                if (subject) {
                    const subjectLessons = lessons.filter(l => l.subjectId === lesson.subjectId);
                    const completedLessons = subjectLessons.filter(l => l.status === 'completed');
                    subject.progress = subjectLessons.length > 0 ? Math.round((completedLessons.length / subjectLessons.length) * 100) : 0;
                }
                
                updateAllSections();
            }
        }



        // Planner table management
        function initializePlannerTables() {
            initializeMonthlyPlanTable();
            initializeWeeklyPlanTable();
        }

        function initializeMonthlyPlanTable() {
            const tableBody = document.getElementById('monthlyPlanTable');
            if (tableBody.children.length === 0) {
                // Add sample rows
                addMonthlyRow('September 2024');
                addMonthlyRow('October 2024');
                addMonthlyRow('November 2024');
            }
        }

        function addMonthlyRow(timePeriod = '', months = '') {
            const tableBody = document.getElementById('monthlyPlanTable');
            const row = document.createElement('tr');
            
            // Create clean spacing based on the months string with sequence numbers
            let monthLines = '';
            let monthInputs = '';
            if (months) {
                const monthArray = months.split(', ');
                monthLines = monthArray.map((month, index) => `<div style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; min-height: 72px; font-size: 0.85rem; color: #374151; font-weight: 500; display: flex; align-items: center;"><span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 8px; font-weight: 600;">${index + 1}</span>${month}</div>`).join('');
                
                // Create individual input boxes with clean spacing for each month
                monthInputs = monthArray.map((month, index) => 
                    `<div style="margin-bottom: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; min-height: 72px; display: flex; align-items: stretch;">
                        <textarea placeholder="${month} content..." style="width: 100%; border: none; background: transparent; resize: both; min-height: 48px; padding: 2px; font-size: 0.85rem; min-width: 150px;"></textarea>
                    </div>`
                ).join('');
            } else {
                monthLines = '<div style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; min-height: 72px; font-size: 0.85rem; color: #374151; font-weight: 500; display: flex; align-items: center;"><span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 8px; font-weight: 600;">1</span>Month 1</div><div style="padding: 12px 8px; border-bottom: 1px solid #e5e7eb; min-height: 72px; font-size: 0.85rem; color: #374151; font-weight: 500; display: flex; align-items: center;"><span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 8px; font-weight: 600;">2</span>Month 2</div><div style="padding: 12px 8px; min-height: 72px; font-size: 0.85rem; color: #374151; font-weight: 500; display: flex; align-items: center;"><span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 8px; font-weight: 600;">3</span>Month 3</div>';
                
                monthInputs = `
                    <div style="margin-bottom: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; min-height: 72px; display: flex; align-items: stretch;">
                        <textarea placeholder="Month 1 content..." style="width: 100%; border: none; background: transparent; resize: both; min-height: 48px; padding: 2px; font-size: 0.85rem; min-width: 150px;"></textarea>
                    </div>
                    <div style="margin-bottom: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; min-height: 72px; display: flex; align-items: stretch;">
                        <textarea placeholder="Month 2 content..." style="width: 100%; border: none; background: transparent; resize: both; min-height: 48px; padding: 2px; font-size: 0.85rem; min-width: 150px;"></textarea>
                    </div>
                    <div style="margin-bottom: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; min-height: 72px; display: flex; align-items: stretch;">
                        <textarea placeholder="Month 3 content..." style="width: 100%; border: none; background: transparent; resize: both; min-height: 48px; padding: 2px; font-size: 0.85rem; min-width: 150px;"></textarea>
                    </div>
                `;
            }
            
            // Calculate row height based on number of months
            const monthCount = months ? months.split(', ').length : 3;
            const cellHeight = monthCount * 80;
            
            row.innerHTML = `
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; height: ${cellHeight}px; resize: horizontal; overflow: auto; min-width: 120px;">
                    <input type="text" value="${timePeriod}" placeholder="Quarter/Period" style="width: 100%; border: none; background: transparent; padding: 4px; font-weight: 600;">
                </td>
                <td style="padding: 0; border: 1px solid #e5e7eb; vertical-align: top; min-width: 120px; height: ${cellHeight}px; resize: horizontal; overflow: auto;">
                    <div style="height: 100%; display: flex; flex-direction: column;">
                        ${monthLines}
                    </div>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; height: ${cellHeight}px; resize: both; overflow: auto; min-width: 200px;">
                    <div style="height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                        ${monthInputs}
                    </div>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; height: ${cellHeight}px; resize: both; overflow: auto; min-width: 200px;">
                    <div style="height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                        ${monthInputs}
                    </div>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; height: ${cellHeight}px; resize: both; overflow: auto; min-width: 200px;">
                    <div style="height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                        ${monthInputs}
                    </div>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; height: ${cellHeight}px; resize: both; overflow: auto; min-width: 200px;">
                    <div style="height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                        ${monthInputs}
                    </div>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; height: ${cellHeight}px; resize: both; overflow: auto; min-width: 200px;">
                    <div style="height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                        ${monthInputs}
                    </div>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; height: ${cellHeight}px; resize: both; overflow: auto; min-width: 200px;">
                    <div style="height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                        ${monthInputs}
                    </div>
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; height: ${cellHeight}px; resize: both; overflow: auto; min-width: 200px;">
                    <div style="height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                        ${monthInputs}
                    </div>
                </td>
            `;
            
            tableBody.appendChild(row);
        }

        function initializeWeeklyPlanTable() {
            const tableBody = document.getElementById('weeklyPlanTable');
            if (tableBody.children.length === 0) {
                // Add sample rows for each subject
                const sampleSubjects = [
                    { name: 'ğŸ”¢ Mathematics', textbook: 'Saxon Math 7/6' },
                    { name: 'ğŸ”¬ Science', textbook: 'Apologia General Science' },
                    { name: 'ğŸ“ English', textbook: 'IEW Student Writing Intensive' },
                    { name: 'ğŸ›ï¸ History', textbook: 'Story of the World Vol. 3' }
                ];
                
                sampleSubjects.forEach(subject => {
                    addSubjectRow(subject.name, subject.textbook);
                });
            }
        }

        function addSubjectRow(subjectName = '', textbook = '') {
            const tableBody = document.getElementById('weeklyPlanTable');
            const row = document.createElement('tr');
            
            // Get current calendar system and country to determine number of weeks to show
            const calendarSystem = document.getElementById('globalCalendarSystem')?.value || 'quarterly';
            const currentCountry = document.getElementById('globalCountryRegion')?.value || 'us';
            
            let weeksToShow;
            switch(calendarSystem) {
                case 'quarterly':
                    // Philippines uses 10 weeks per quarter, others use 9-12
                    weeksToShow = currentCountry === 'ph' ? 10 : 9;
                    break;
                case 'semester':
                    weeksToShow = 12; // Show 12 weeks max for semester (18 is too many columns)
                    break;
                case 'trimester':
                    weeksToShow = 12;
                    break;
                case 'termly':
                    weeksToShow = 12; // UK term system
                    break;
                case 'monthly':
                    weeksToShow = 4;
                    break;
                default:
                    weeksToShow = 12;
            }
            
            let weekCells = '';
            for (let i = 1; i <= 12; i++) {
                const displayStyle = i <= weeksToShow ? 'table-cell' : 'none';
                weekCells += `
                    <td style="padding: 8px; border: 1px solid #e5e7eb; display: ${displayStyle}; resize: both; overflow: auto; min-width: 100px;">
                        <textarea placeholder="Week ${i} content..." style="width: 100%; border: none; background: transparent; resize: both; min-height: 50px; padding: 4px; font-size: 0.8rem; min-width: 80px;" onchange="triggerAutoSave()"></textarea>
                    </td>
                `;
            }
            
            row.innerHTML = `
                <td style="padding: 8px; border: 1px solid #e5e7eb; resize: horizontal; overflow: auto; min-width: 120px;">
                    <input type="text" value="${subjectName}" placeholder="Subject" style="width: 100%; border: none; background: transparent; padding: 4px; font-weight: 600;">
                </td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; resize: horizontal; overflow: auto; min-width: 150px;">
                    <input type="text" value="${textbook}" placeholder="Textbook/Resource" style="width: 100%; border: none; background: transparent; padding: 4px;">
                </td>
                ${weekCells}
            `;
            
            tableBody.appendChild(row);
        }

        // Add a new column to the monthly planning table
        function addColumnToTable() {
            const table = document.querySelector('#monthlyPlanTable').closest('table');
            const headerRow = table.querySelector('thead tr');
            const bodyRows = table.querySelectorAll('tbody tr');
            
            // Add header
            const newHeader = document.createElement('th');
            newHeader.style.cssText = 'padding: 12px; border: 1px solid #1e40af; font-weight: 600; color: white;';
            newHeader.textContent = 'Custom Column';
            headerRow.appendChild(newHeader);
            
            // Add cells to existing rows
            bodyRows.forEach(row => {
                const newCell = document.createElement('td');
                newCell.style.cssText = 'padding: 8px; border: 1px solid #e5e7eb; vertical-align: top; min-height: 180px;';
                
                // Get the number of months from the second cell
                const monthsCell = row.cells[1];
                const monthCount = monthsCell ? monthsCell.querySelectorAll('div').length : 3;
                
                let monthInputs = '';
                for (let i = 1; i <= monthCount; i++) {
                    monthInputs += `
                        <div style="margin-bottom: 8px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f8fafc; min-height: 60px;">
                            <textarea placeholder="Month ${i} content..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 40px; padding: 2px; font-size: 0.85rem;"></textarea>
                        </div>
                    `;
                }
                
                newCell.innerHTML = monthInputs;
                row.appendChild(newCell);
            });
            
            alert('âœ… New column added! You can edit the header by clicking on it.');
        }

        // Add a new week column to the weekly planning table
        function addWeekColumn() {
            const table = document.querySelector('#weeklyPlanTable').closest('table');
            const headerRow = table.querySelector('thead tr');
            const bodyRows = table.querySelectorAll('tbody tr');
            
            // Find the next week number
            const existingWeekHeaders = Array.from(headerRow.querySelectorAll('th')).slice(2); // Skip first 2 columns
            const visibleWeeks = existingWeekHeaders.filter(th => th.style.display !== 'none').length;
            const nextWeekNumber = visibleWeeks + 1;
            
            // Check if we can show an existing hidden week first
            for (let i = 1; i <= 12; i++) {
                const header = document.getElementById(`week${i}Header`);
                if (header && header.style.display === 'none') {
                    header.style.display = 'table-cell';
                    
                    // Show corresponding cells in all rows
                    bodyRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells[i + 1]) { // +1 because first 2 cells are subject and textbook
                            cells[i + 1].style.display = 'table-cell';
                        }
                    });
                    
                    alert(`âœ… Week ${i} column is now visible!`);
                    return;
                }
            }
            
            // If all 12 weeks are visible, add a new column beyond the standard 12
            const newHeader = document.createElement('th');
            newHeader.style.cssText = 'padding: 12px; border: 1px solid #065f46; font-weight: 600; color: white; min-width: 100px;';
            newHeader.textContent = `Week ${nextWeekNumber}`;
            headerRow.appendChild(newHeader);
            
            // Add cells to existing rows
            bodyRows.forEach(row => {
                const newCell = document.createElement('td');
                newCell.style.cssText = 'padding: 8px; border: 1px solid #e5e7eb;';
                newCell.innerHTML = `
                    <textarea placeholder="Week ${nextWeekNumber} content..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px; font-size: 0.8rem;" onchange="triggerAutoSave()"></textarea>
                `;
                row.appendChild(newCell);
            });
            
            alert(`âœ… Week ${nextWeekNumber} column added!`);
        }

        // Track completed weeks
        let completedWeeks = JSON.parse(localStorage.getItem('eduflow_completed_weeks') || '[]');

        function markWeekComplete() {
            const weeklyTable = document.getElementById('weeklyPlanTable');
            if (!weeklyTable) return;
            
            // Find the current week (first visible week with content)
            const headerRow = weeklyTable.closest('table').querySelector('thead tr');
            const weekHeaders = Array.from(headerRow.querySelectorAll('th')).slice(2); // Skip subject and textbook columns
            const visibleWeekHeaders = weekHeaders.filter(th => th.style.display !== 'none');
            
            if (visibleWeekHeaders.length === 0) {
                alert('âŒ No weeks available to mark complete. Please add some weekly planning first.');
                return;
            }
            
            // Check if current week has content
            const rows = weeklyTable.querySelectorAll('tr');
            let hasContent = false;
            let currentWeekIndex = 0;
            
            // Find the first week with some content
            for (let weekIndex = 0; weekIndex < visibleWeekHeaders.length; weekIndex++) {
                let weekHasContent = false;
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const weekCell = cells[weekIndex + 2]; // +2 for subject and textbook columns
                    if (weekCell) {
                        const textarea = weekCell.querySelector('textarea');
                        if (textarea && textarea.value.trim().length > 5) {
                            weekHasContent = true;
                        }
                    }
                });
                
                if (weekHasContent) {
                    hasContent = true;
                    currentWeekIndex = weekIndex;
                    break;
                }
            }
            
            if (!hasContent) {
                alert('âŒ Please add some content to your weekly planning before marking it complete.\n\nFill in at least a few subjects with planning details, then try again.');
                return;
            }
            
            const currentWeekNumber = currentWeekIndex + 1;
            const weekId = `week_${currentWeekNumber}_${Date.now()}`;
            
            // Check if this week is already marked complete
            const alreadyCompleted = completedWeeks.some(week => week.weekNumber === currentWeekNumber);
            
            if (alreadyCompleted) {
                const confirmReplace = confirm(`Week ${currentWeekNumber} is already marked complete.\n\nDo you want to update the completion record?`);
                if (!confirmReplace) return;
                
                // Remove old record
                completedWeeks = completedWeeks.filter(week => week.weekNumber !== currentWeekNumber);
            }
            
            // Add completion record
            completedWeeks.push({
                id: weekId,
                weekNumber: currentWeekNumber,
                completedDate: new Date().toISOString(),
                subjectCount: rows.length
            });
            
            // Save to localStorage
            localStorage.setItem('eduflow_completed_weeks', JSON.stringify(completedWeeks));
            
            // Update milestone progress
            updateMilestoneProgress('weekly', 1);
            
            // Visual feedback
            const weekHeader = visibleWeekHeaders[currentWeekIndex];
            if (weekHeader) {
                weekHeader.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                weekHeader.innerHTML = `âœ… Week ${currentWeekNumber} (Complete)`;
            }
            
            // Show success message
            alert(`ğŸ‰ Week ${currentWeekNumber} Marked Complete!\n\nâœ… Completion recorded\nğŸ“Š Progress updated\nğŸ† Milestone progress tracked\n\nGreat job on completing your weekly planning!`);
            
            // Trigger auto-save
            triggerAutoSave();
        }

        function markDayComplete() {
            const currentDay = document.getElementById('scheduleDay').value;
            const scheduleDate = document.getElementById('scheduleDate').value;
            const scheduleTable = document.getElementById('scheduleTable');
            
            if (!scheduleTable) return;
            
            // Check if day has content
            const rows = scheduleTable.querySelectorAll('tr');
            let hasContent = false;
            let filledSlots = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    const timeSlot = cells[0].querySelector('input')?.value || '';
                    const subject = cells[1].querySelector('select')?.value || '';
                    const objectives = cells[2].querySelector('textarea')?.value || '';
                    
                    if (timeSlot.trim() && subject.trim() && objectives.trim().length > 5) {
                        hasContent = true;
                        filledSlots++;
                    }
                }
            });
            
            if (!hasContent) {
                alert('âŒ Please add some content to your daily schedule before marking it complete.\n\nFill in time slots, subjects, and learning objectives, then try again.');
                return;
            }
            
            // Save completion record
            let completedDays = JSON.parse(localStorage.getItem('eduflow_completed_days') || '[]');
            const dayId = `${currentDay}_${scheduleDate}`;
            
            // Remove existing record for this day
            completedDays = completedDays.filter(day => day.id !== dayId);
            
            // Add new completion record
            completedDays.push({
                id: dayId,
                day: currentDay,
                date: scheduleDate,
                completedDate: new Date().toISOString(),
                filledSlots: filledSlots
            });
            
            localStorage.setItem('eduflow_completed_days', JSON.stringify(completedDays));
            
            // Update milestone progress
            updateMilestoneProgress('days', 1);
            
            alert(`ğŸ‰ ${currentDay.charAt(0).toUpperCase() + currentDay.slice(1)} Schedule Complete!\n\nâœ… ${filledSlots} time slots completed\nğŸ“… Date: ${scheduleDate}\nğŸ† Progress tracked\n\nExcellent work on your daily planning!`);
            
            // Trigger auto-save
            triggerAutoSave();
        }

        // Update weekly planning to sync with subjects
        function syncWeeklyPlanningWithSubjects() {
            const tableBody = document.getElementById('weeklyPlanTable');
            if (!tableBody) return;
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Add rows for each subject
            subjects.forEach(subject => {
                addSubjectRow(`${subject.emoji} ${subject.name}`, 'Curriculum Resource');
            });
        }

        function updatePlanningFocus() {
            const focus = document.getElementById('subjectFocus').value;
            const tableBody = document.getElementById('monthlyPlanTable');
            const calendarSystem = document.getElementById('globalCalendarSystem').value;
            const schoolYearStart = document.getElementById('globalSchoolYearStart').value;
            const country = document.getElementById('globalCountryRegion').value;
            
            // Clear existing table
            if (tableBody) {
                tableBody.innerHTML = '';
            }
            
            // Get school year start month
            let startMonth = 8; // Default to September (month 8)
            if (schoolYearStart) {
                startMonth = parseInt(schoolYearStart.split('-')[1]) - 1; // Convert to 0-based month
            }
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Add appropriate periods based on focus and calendar system
            let periods = [];
            
            switch(focus) {
                case 'unit':
                    // 4-6 week unit - show as weeks within current period
                    const currentMonth = monthNames[startMonth];
                    periods = [
                        { name: 'Week 1-2', months: `${currentMonth} (Weeks 1-2)` },
                        { name: 'Week 3-4', months: `${currentMonth} (Weeks 3-4)` },
                        { name: 'Week 5-6', months: `${currentMonth} (Weeks 5-6)` }
                    ];
                    break;
                    
                case 'quarter':
                    // Single quarter - 3 months
                    if (calendarSystem === 'quarterly' || country === 'ph') {
                        const month1 = monthNames[startMonth];
                        const month2 = monthNames[(startMonth + 1) % 12];
                        const month3 = monthNames[(startMonth + 2) % 12];
                        periods = [
                            { name: 'Quarter 1', months: `${month1}, ${month2}, ${month3}` }
                        ];
                    } else if (calendarSystem === 'semester') {
                        // First half of semester
                        const monthsInPeriod = [];
                        for (let i = 0; i < 3; i++) {
                            monthsInPeriod.push(monthNames[(startMonth + i) % 12]);
                        }
                        periods = [
                            { name: 'Semester 1 (First Half)', months: monthsInPeriod.join(', ') }
                        ];
                    } else if (calendarSystem === 'trimester') {
                        // First trimester
                        const monthsInPeriod = [];
                        for (let i = 0; i < 4; i++) {
                            monthsInPeriod.push(monthNames[(startMonth + i) % 12]);
                        }
                        periods = [
                            { name: 'Trimester 1', months: monthsInPeriod.join(', ') }
                        ];
                    }
                    break;
                    
                case 'semester':
                    // Full semester - ONE semester only (18-20 weeks)
                    if (calendarSystem === 'semester') {
                        // Show only ONE semester
                        const semester1Months = [];
                        for (let i = 0; i < 6; i++) {
                            semester1Months.push(monthNames[(startMonth + i) % 12]);
                        }
                        periods = [
                            { name: 'Semester 1 (Full Semester)', months: semester1Months.join(', ') }
                        ];
                    } else if (calendarSystem === 'quarterly') {
                        // Two quarters = semester
                        const q1Months = [];
                        const q2Months = [];
                        for (let i = 0; i < 3; i++) {
                            q1Months.push(monthNames[(startMonth + i) % 12]);
                            q2Months.push(monthNames[(startMonth + 3 + i) % 12]);
                        }
                        periods = [
                            { name: 'Quarter 1', months: q1Months.join(', ') },
                            { name: 'Quarter 2', months: q2Months.join(', ') }
                        ];
                    } else if (calendarSystem === 'trimester') {
                        // Two trimesters
                        const t1Months = [];
                        const t2Months = [];
                        for (let i = 0; i < 4; i++) {
                            t1Months.push(monthNames[(startMonth + i) % 12]);
                            t2Months.push(monthNames[(startMonth + 4 + i) % 12]);
                        }
                        periods = [
                            { name: 'Trimester 1', months: t1Months.join(', ') },
                            { name: 'Trimester 2', months: t2Months.join(', ') }
                        ];
                    }
                    break;
                    
                case 'two-terms':
                    // Two terms only (for term-based countries)
                    if (calendarSystem === 'termly') {
                        const termNames = ['Autumn Term', 'Spring Term'];
                        const termMonths = [
                            ['September', 'October', 'November', 'December'],
                            ['January', 'February', 'March', 'April']
                        ];
                        for (let t = 0; t < 2; t++) {
                            periods.push({ name: termNames[t], months: termMonths[t].join(', ') });
                        }
                    }
                    break;
                    
                case 'year':
                    // Full academic year - based on calendar system
                    if (calendarSystem === 'quarterly') {
                        for (let q = 1; q <= 4; q++) {
                            const quarterMonths = [];
                            for (let i = 0; i < 3; i++) {
                                quarterMonths.push(monthNames[(startMonth + (q - 1) * 3 + i) % 12]);
                            }
                            periods.push({ name: `Quarter ${q}`, months: quarterMonths.join(', ') });
                        }
                    } else if (calendarSystem === 'semester') {
                        for (let s = 1; s <= 2; s++) {
                            const semesterMonths = [];
                            for (let i = 0; i < 6; i++) {
                                semesterMonths.push(monthNames[(startMonth + (s - 1) * 6 + i) % 12]);
                            }
                            periods.push({ name: `Semester ${s}`, months: semesterMonths.join(', ') });
                        }
                    } else if (calendarSystem === 'trimester') {
                        for (let t = 1; t <= 3; t++) {
                            const trimesterMonths = [];
                            for (let i = 0; i < 4; i++) {
                                trimesterMonths.push(monthNames[(startMonth + (t - 1) * 4 + i) % 12]);
                            }
                            periods.push({ name: `Trimester ${t}`, months: trimesterMonths.join(', ') });
                        }
                    } else if (calendarSystem === 'termly') {
                        // UK system: 3 terms
                        const termNames = ['Autumn Term', 'Spring Term', 'Summer Term'];
                        const termMonths = [
                            ['September', 'October', 'November', 'December'],
                            ['January', 'February', 'March', 'April'],
                            ['April', 'May', 'June', 'July']
                        ];
                        for (let t = 0; t < 3; t++) {
                            periods.push({ name: termNames[t], months: termMonths[t].join(', ') });
                        }
                    } else if (calendarSystem === 'monthly') {
                        // 10 months of school year
                        for (let m = 0; m < 10; m++) {
                            const monthName = monthNames[(startMonth + m) % 12];
                            periods.push({ name: monthName, months: monthName });
                        }
                    }
                    break;
            }
            
            // Add rows to table
            periods.forEach(period => {
                addMonthlyRow(period.name, period.months);
            });
            
            // Update planning guidance
            const focusDescriptions = {
                'unit': 'Focus on a specific topic or skill set over 4-6 weeks',
                'quarter': 'Plan comprehensive learning for a 10-12 week period',
                'two-terms': 'Plan for two academic terms (20-28 weeks)',
                'semester': 'Design curriculum for one full semester (18-20 weeks)',
                'year': 'Create a complete yearly curriculum plan (36-40 weeks)'
            };
            
            console.log(`Planning focus updated to: ${focusDescriptions[focus]} using ${calendarSystem} system`);
        }

        function updatePlanningScope() {
            const scope = document.getElementById('planningScope').value;
            const tableBody = document.getElementById('weeklyPlanTable');
            
            // Clear existing table
            if (tableBody) {
                tableBody.innerHTML = '';
            }
            
            let subjectsToAdd = [];
            switch(scope) {
                case 'core':
                    subjectsToAdd = [
                        { name: 'ğŸ”¢ Mathematics', textbook: 'Core Math Curriculum' },
                        { name: 'ğŸ“ English Language Arts', textbook: 'Core ELA Curriculum' },
                        { name: 'ğŸ”¬ Science', textbook: 'Core Science Curriculum' },
                        { name: 'ğŸ›ï¸ Social Studies', textbook: 'Core History Curriculum' }
                    ];
                    break;
                case 'selected':
                    // Use current subjects from the subjects array
                    subjectsToAdd = subjects.slice(0, 4).map(subject => ({
                        name: `${subject.emoji} ${subject.name}`,
                        textbook: 'Selected Curriculum'
                    }));
                    break;
                case 'interdisciplinary':
                    subjectsToAdd = [
                        { name: 'ğŸŒ Environmental Science', textbook: 'Interdisciplinary Approach' },
                        { name: 'ğŸ¨ Creative Arts Integration', textbook: 'Arts-Based Learning' },
                        { name: 'ğŸ’» STEM Projects', textbook: 'Project-Based Learning' },
                        { name: 'ğŸ“š Literature & History', textbook: 'Humanities Integration' }
                    ];
                    break;
                default: // 'all'
                    subjectsToAdd = subjects.map(subject => ({
                        name: `${subject.emoji} ${subject.name}`,
                        textbook: 'Comprehensive Curriculum'
                    }));
            }
            
            subjectsToAdd.forEach(subject => {
                addSubjectRow(subject.name, subject.textbook);
            });
            
            console.log(`Planning scope updated to: ${scope}`);
        }

        function generateSubjectPlan() {
            const subjectId = document.getElementById('subjectSelect').value;
            const grade = document.getElementById('globalGradeLevel').value;
            const yearStart = document.getElementById('globalSchoolYearStart').value;
            const calendar = document.getElementById('globalCalendarSystem').value;
            const focus = document.getElementById('subjectFocus').value;
            
            if (!subjectId || !grade) {
                alert('Please select a subject and grade level first.');
                return;
            }
            
            const subject = subjects.find(s => s.id == subjectId);
            if (!subject) return;
            
            // Update the monthly planning title to show selected subject and focus
            const titleElement = document.getElementById('monthlyPlanningTitle');
            if (titleElement) {
                const focusText = focus === 'unit' ? 'Unit Planning' : 
                                 focus === 'quarter' ? 'Quarterly Planning' :
                                 focus === 'semester' ? 'Semester Planning' : 'Yearly Planning';
                titleElement.textContent = `${subject.emoji} ${subject.name} - ${focusText}`;
            }
            
            // Auto-populate planning sections with FULLY DYNAMIC data (updates for ANY subject)
            const subjectSpecificContent = getSubjectSpecificContent(subject.name, subject.emoji);
            
            const focusGoals = {
                'unit': `Unit Learning Goals for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.unitGoals}\nâ€¢ Master specific concepts within this 4-6 week unit\nâ€¢ Complete targeted assessments\nâ€¢ Build foundation for next unit\nâ€¢ Apply skills in practical contexts`,
                'quarter': `Quarterly Goals for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.quarterGoals}\nâ€¢ Complete major curriculum milestones\nâ€¢ Develop comprehensive understanding\nâ€¢ Prepare for mid-term assessments\nâ€¢ Build interdisciplinary connections`,
                'two-terms': `Two-Term Goals for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.termGoals}\nâ€¢ Complete major curriculum sections\nâ€¢ Achieve substantial learning progress\nâ€¢ Prepare for end-of-term assessments\nâ€¢ Build strong foundation for remaining terms`,
                'semester': `Semester Goals for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.semesterGoals}\nâ€¢ Achieve grade-level proficiency standards\nâ€¢ Complete major projects and assessments\nâ€¢ Demonstrate mastery of core concepts\nâ€¢ Prepare for advanced coursework`,
                'year': `Annual Goals for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.yearGoals}\nâ€¢ Meet all grade-level standards\nâ€¢ Complete comprehensive curriculum\nâ€¢ Demonstrate year-end proficiency\nâ€¢ Prepare for next grade level`
            };
            
            const focusPrerequisites = {
                'unit': `Prerequisites for ${focus} planning in ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.prerequisites}\nâ€¢ Previous unit/lesson completion\nâ€¢ Specific foundational skills for this topic\nâ€¢ Required materials and resources\nâ€¢ Appropriate skill level for unit content`,
                'quarter': `Prerequisites for ${focus} planning in ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.prerequisites}\nâ€¢ Previous quarter completion\nâ€¢ Grade-level foundational skills\nâ€¢ Access to quarterly materials\nâ€¢ Readiness for extended learning period`,
                'two-terms': `Prerequisites for ${focus} planning in ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.prerequisites}\nâ€¢ Previous term completion\nâ€¢ Solid foundational knowledge base\nâ€¢ Access to comprehensive resources\nâ€¢ Readiness for substantial learning commitment`,
                'semester': `Prerequisites for ${focus} planning in ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.prerequisites}\nâ€¢ Previous semester/grade completion\nâ€¢ Strong foundational skills\nâ€¢ Access to semester-long resources\nâ€¢ Appropriate reading and comprehension level`,
                'year': `Prerequisites for ${focus} planning in ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.prerequisites}\nâ€¢ Previous grade completion\nâ€¢ All prerequisite skills mastered\nâ€¢ Full access to yearly curriculum materials\nâ€¢ Readiness for grade-level expectations`
            };
            
            const focusTeaching = {
                'unit': `${focus.charAt(0).toUpperCase() + focus.slice(1)} Teaching Strategy for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.teaching}\nâ€¢ Focus on specific unit objectives\nâ€¢ Use targeted instructional methods\nâ€¢ Monitor unit progress weekly\nâ€¢ Adjust pacing within unit timeframe\nâ€¢ Prepare for unit assessment`,
                'quarter': `${focus.charAt(0).toUpperCase() + focus.slice(1)} Teaching Strategy for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.teaching}\nâ€¢ Plan for quarterly milestones\nâ€¢ Use varied instructional approaches\nâ€¢ Monitor progress monthly\nâ€¢ Adjust pacing across 10-12 weeks\nâ€¢ Prepare for quarterly assessments`,
                'two-terms': `${focus.charAt(0).toUpperCase() + focus.slice(1)} Teaching Strategy for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.teaching}\nâ€¢ Plan for two-term progression\nâ€¢ Use comprehensive teaching methods\nâ€¢ Monitor progress bi-monthly\nâ€¢ Adjust pacing across 20-28 weeks\nâ€¢ Prepare for term-end evaluations`,
                'semester': `${focus.charAt(0).toUpperCase() + focus.slice(1)} Teaching Strategy for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.teaching}\nâ€¢ Plan for semester-long progression\nâ€¢ Use comprehensive instructional methods\nâ€¢ Monitor progress regularly\nâ€¢ Adjust pacing across 18-20 weeks\nâ€¢ Prepare for semester finals`,
                'year': `${focus.charAt(0).toUpperCase() + focus.slice(1)} Teaching Strategy for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.teaching}\nâ€¢ Plan for year-long progression\nâ€¢ Use diverse instructional methods\nâ€¢ Monitor progress quarterly\nâ€¢ Adjust pacing across full academic year\nâ€¢ Prepare for year-end assessments`
            };
            
            const focusConnections = {
                'unit': `${focus.charAt(0).toUpperCase() + focus.slice(1)} Connections for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.connections}\nâ€¢ Link to other current units\nâ€¢ Connect to real-world applications\nâ€¢ Relate to student experiences\nâ€¢ Build toward next unit\nâ€¢ Create focused learning pathways`,
                'quarter': `${focus.charAt(0).toUpperCase() + focus.slice(1)} Connections for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.connections}\nâ€¢ Link to other quarterly subjects\nâ€¢ Connect to seasonal/quarterly themes\nâ€¢ Relate to student interests\nâ€¢ Build community connections\nâ€¢ Create quarterly learning pathways`,
                'two-terms': `${focus.charAt(0).toUpperCase() + focus.slice(1)} Connections for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.connections}\nâ€¢ Link across multiple subjects\nâ€¢ Connect to extended projects\nâ€¢ Relate to student development\nâ€¢ Build lasting community connections\nâ€¢ Create comprehensive learning pathways`,
                'semester': `${focus.charAt(0).toUpperCase() + focus.slice(1)} Connections for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.connections}\nâ€¢ Link to all semester subjects\nâ€¢ Connect to major projects\nâ€¢ Relate to student growth\nâ€¢ Build strong community connections\nâ€¢ Create semester-long learning pathways`,
                'year': `${focus.charAt(0).toUpperCase() + focus.slice(1)} Connections for ${subject.emoji} ${subject.name}:\n${subjectSpecificContent.connections}\nâ€¢ Link to entire curriculum\nâ€¢ Connect to year-long projects\nâ€¢ Relate to student development\nâ€¢ Build comprehensive community connections\nâ€¢ Create complete learning pathways`
            };
            
            // Only update if fields are empty or user confirms overwrite
            const learningGoalsField = document.getElementById('learningGoals');
            const prerequisitesField = document.getElementById('prerequisites');
            const teachingNotesField = document.getElementById('teachingNotes');
            const mappingInsightsField = document.getElementById('mappingInsights');
            
            const shouldUpdate = learningGoalsField.value.trim() === '' || 
                               confirm('This will overwrite your existing planning content. Continue?');
            
            if (shouldUpdate) {
                learningGoalsField.value = focusGoals[focus];
                prerequisitesField.value = focusPrerequisites[focus];
                teachingNotesField.value = focusTeaching[focus];
                mappingInsightsField.value = focusConnections[focus];
            }
            
            // Update the calendar table with the new system and focus
            updatePlanningFocus();
            
            alert(`âœ… Generated ${focus} plan for ${subject.emoji} ${subject.name} (${grade})!\n\nPlanning Focus: ${focus}\nCalendar System: ${calendar}\n\nThe planning sections have been customized for your selected focus. You can now add specific content for each period.`);
        }

        function generatePeriodPlan() {
            const period = document.getElementById('quarterSelect').value;
            const year = document.getElementById('academicYear').value;
            const country = document.getElementById('countryRegion').value;
            const language = document.getElementById('interfaceLanguage').value;
            
            const curriculum = globalCurricula[country];
            if (!curriculum) return;
            
            // Clear and populate weekly planning table with subjects from selected country
            const tableBody = document.getElementById('weeklyPlanTable');
            tableBody.innerHTML = '';
            
            // Add subjects based on selected country's curriculum
            curriculum.subjects.slice(0, 6).forEach(subjectName => {
                addSubjectRow(subjectName, 'Curriculum Resource');
            });
            
            // Update academic year based on school year start
            updateAcademicYear();
            
            alert(`âœ… Generated period plan for ${period} ${year}!\n\nCountry: ${curriculum.name}\nStandards: ${curriculum.standards}\nInterface: ${language}\n\nThe weekly planning table has been populated with subjects from the ${curriculum.name} curriculum. You can now add specific content for each week.`);
        }

        // Progress tracking
        function loadProgressCharts() {
            const container = document.getElementById('progressCharts');
            container.innerHTML = '';
            
            subjects.forEach(subject => {
                const chartDiv = document.createElement('div');
                chartDiv.style.cssText = 'margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 12px;';
                chartDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #374151;">${subject.emoji} ${subject.name}</span>
                        <span style="font-weight: 600; color: #6366f1;">${subject.progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${subject.progress}%"></div>
                    </div>
                `;
                container.appendChild(chartDiv);
            });
        }

        function loadMilestones() {
            const container = document.getElementById('milestones');
            
            // FORCE REFRESH: Always recalculate milestones from scratch
            console.log('ğŸ”„ Force updating milestones...');
            
            // ALWAYS reset milestones to ensure latest version with auto-tracking
            let milestones = [
                { id: 1, title: 'Subject Master', description: 'Add subjects to your curriculum (auto-updates when you add subjects)', achieved: false, target: 5, current: 0, type: 'subjects', autoTrack: true },
                { id: 2, title: 'Content Creator', description: 'Fill in planning cells with content (auto-updates as you type)', achieved: false, target: 20, current: 0, type: 'content', autoTrack: true },
                { id: 3, title: 'Schedule Setter', description: 'Create daily schedule time slots (auto-updates when you add schedules)', achieved: false, target: 6, current: 0, type: 'schedules', autoTrack: true },
                { id: 4, title: 'Weekly Warrior', description: 'Complete weekly planning for subjects (auto-updates when you fill weekly plans)', achieved: false, target: 1, current: 0, type: 'weekly', autoTrack: true },
                { id: 5, title: 'Planning Pro', description: 'Complete quarterly planning sections (auto-updates when you fill monthly plans)', achieved: false, target: 1, current: 0, type: 'quarters', autoTrack: true },
                { id: 6, title: 'Curriculum Designer', description: 'Use the planner for multiple days (auto-updates based on usage)', achieved: false, target: 3, current: 0, type: 'days', autoTrack: true }
            ];
            
            // Check if we have saved milestones and merge any custom ones
            const savedMilestones = JSON.parse(localStorage.getItem('eduflow_milestones') || '[]');
            const customMilestones = savedMilestones.filter(m => m.type === 'custom' || !m.autoTrack);
            
            // Add custom milestones to the default auto-tracking ones
            milestones = [...milestones, ...customMilestones];
            
            // FORCE UPDATE: Always recalculate ALL milestone progress
            milestones.forEach(milestone => {
                if (milestone.autoTrack) {
                    const previousCurrent = milestone.current;
                    
                    // Force recalculation
                    switch(milestone.type) {
                        case 'subjects':
                            milestone.current = subjects.length;
                            console.log(`ğŸ“Š Subjects count: ${milestone.current}`);
                            break;
                        case 'content':
                            milestone.current = countFilledPlanningCells();
                            console.log(`ğŸ“ Content cells: ${milestone.current}`);
                            break;
                        case 'schedules':
                            milestone.current = countCompletedSchedules();
                            console.log(`ğŸ• Schedules: ${milestone.current}`);
                            break;
                        case 'weekly':
                            milestone.current = countCompletedWeeklyPlanning();
                            console.log(`ğŸ“… Weekly planning: ${milestone.current}`);
                            break;
                        case 'quarters':
                            milestone.current = countCompletedQuarters();
                            console.log(`ğŸ“Š Quarters: ${milestone.current}`);
                            break;
                        case 'days':
                            milestone.current = getDaysUsed();
                            console.log(`ğŸ“† Days used: ${milestone.current}`);
                            break;
                    }
                    
                    // Update achievement status
                    const wasAchieved = milestone.achieved;
                    milestone.achieved = milestone.current >= milestone.target;
                    
                    // Log all changes
                    if (previousCurrent !== milestone.current || wasAchieved !== milestone.achieved) {
                        console.log(`ğŸ¯ ${milestone.title}: ${previousCurrent} â†’ ${milestone.current} (${milestone.achieved ? 'ACHIEVED' : 'in progress'})`);
                    }
                }
            });
            
            // FORCE SAVE: Always save updated milestones
            localStorage.setItem('eduflow_milestones', JSON.stringify(milestones));
            console.log('ğŸ’¾ Milestones force-saved to localStorage');
            
            container.innerHTML = '';
            
            // Add milestone management header with explanation
            const headerDiv = document.createElement('div');
            headerDiv.style.cssText = 'margin-bottom: 20px;';
            headerDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="margin: 0; color: #374151;">ğŸ¯ Achievement Milestones</h4>
                    <button class="btn" onclick="addCustomMilestone()" style="padding: 8px 16px; font-size: 0.9rem;">
                        â• Add Custom Goal
                    </button>
                </div>
                <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 16px;">
                    <p style="margin: 0; font-size: 0.9rem; color: #1e40af;">
                        <strong>ğŸ“Š Auto-Tracking:</strong> Most milestones update automatically as you work. 
                        Progress is tracked based on your actual usage - adding subjects, filling planning cells, creating schedules, etc.
                        <br><strong>ğŸ¯ Manual Goals:</strong> Custom milestones can be marked complete manually when you achieve them.
                    </p>
                </div>
            `;
            container.appendChild(headerDiv);
            
            milestones.forEach(milestone => {
                const progressPercent = Math.min(100, (milestone.current / milestone.target) * 100);
                const milestoneDiv = document.createElement('div');
                milestoneDiv.style.cssText = `
                    padding: 16px; 
                    background: ${milestone.achieved ? '#dcfce7' : '#f9fafb'}; 
                    border-radius: 12px; 
                    margin-bottom: 12px;
                    border-left: 4px solid ${milestone.achieved ? '#22c55e' : '#d1d5db'};
                    transition: all 0.3s ease;
                `;
                
                const trackingBadge = milestone.autoTrack ? 
                    '<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">AUTO</span>' :
                    '<span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; font-weight: 600;">MANUAL</span>';
                
                const manualCompleteButton = !milestone.autoTrack && !milestone.achieved ? 
                    `<button onclick="markMilestoneComplete(${milestone.id})" style="background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; margin-left: 8px; cursor: pointer;">âœ“ Mark Complete</button>` : '';
                
                milestoneDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <span style="font-size: 1.5rem;">${milestone.achieved ? 'ğŸ†' : 'â³'}</span>
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <h4 style="margin: 0; color: #374151;">${milestone.title}</h4>
                                    ${trackingBadge}
                                </div>
                                <p style="color: #6b7280; margin: 0 0 8px 0;">${milestone.description}</p>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="flex: 1; background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                        <div style="width: ${progressPercent}%; height: 100%; background: ${milestone.achieved ? '#22c55e' : '#3b82f6'}; transition: width 0.3s ease;"></div>
                                    </div>
                                    <span style="font-size: 0.8rem; color: #6b7280; font-weight: 600;">${milestone.current}/${milestone.target}</span>
                                    ${manualCompleteButton}
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteMilestone(${milestone.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 4px; font-size: 1.2rem;" title="Delete milestone">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(milestoneDiv);
            });
            
            // Save updated milestones
            localStorage.setItem('eduflow_milestones', JSON.stringify(milestones));
        }

        // Helper functions for milestone tracking
        function countFilledPlanningCells() {
            let count = 0;
            // Count filled cells in monthly planning table
            const monthlyTable = document.getElementById('monthlyPlanTable');
            if (monthlyTable) {
                const textareas = monthlyTable.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    if (textarea.value.trim().length > 10) count++; // At least 10 characters
                });
            }
            
            // Count filled cells in weekly planning table
            const weeklyTable = document.getElementById('weeklyPlanTable');
            if (weeklyTable) {
                const textareas = weeklyTable.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    if (textarea.value.trim().length > 10) count++; // At least 10 characters
                });
            }
            
            return count;
        }

        function countCompletedSchedules() {
            const scheduleTable = document.getElementById('scheduleTable');
            if (!scheduleTable) return 0;
            
            const rows = scheduleTable.querySelectorAll('tr');
            let completedRows = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    const timeSlot = cells[0].querySelector('input')?.value || '';
                    const subject = cells[1].querySelector('select')?.value || '';
                    const objectives = cells[2].querySelector('textarea')?.value || '';
                    
                    if (timeSlot.trim() && subject.trim() && objectives.trim().length > 5) {
                        completedRows++;
                    }
                }
            });
            
            return completedRows >= 6 ? 1 : 0; // Consider complete if 6+ time slots are filled
        }

        function countCompletedWeeklyPlanning() {
            const weeklyTable = document.getElementById('weeklyPlanTable');
            if (!weeklyTable) return 0;
            
            const rows = weeklyTable.querySelectorAll('tr');
            let completedSubjects = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    let filledWeeks = 0;
                    // Check first 4 week columns (skip subject and textbook columns)
                    for (let i = 2; i < Math.min(6, cells.length); i++) {
                        const textarea = cells[i].querySelector('textarea');
                        if (textarea && textarea.value.trim().length > 5) {
                            filledWeeks++;
                        }
                    }
                    if (filledWeeks >= 3) completedSubjects++; // At least 3 weeks filled
                }
            });
            
            return completedSubjects >= 4 ? 1 : 0; // Consider complete if 4+ subjects have weekly planning
        }

        function countCompletedQuarters() {
            const monthlyTable = document.getElementById('monthlyPlanTable');
            if (!monthlyTable) return 0;
            
            const rows = monthlyTable.querySelectorAll('tr');
            let completedQuarters = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    let filledColumns = 0;
                    // Check key planning columns (skip time period and months)
                    for (let i = 2; i < Math.min(6, cells.length); i++) {
                        const textareas = cells[i].querySelectorAll('textarea');
                        let columnFilled = false;
                        textareas.forEach(textarea => {
                            if (textarea.value.trim().length > 10) {
                                columnFilled = true;
                            }
                        });
                        if (columnFilled) filledColumns++;
                    }
                    if (filledColumns >= 3) completedQuarters++; // At least 3 columns filled
                }
            });
            
            return Math.min(1, completedQuarters); // Max 1 for this milestone
        }

        function getDaysUsed() {
            const savedData = localStorage.getItem('eduflow_autosave');
            if (!savedData) return 0;
            
            try {
                const data = JSON.parse(savedData);
                const saveDate = new Date(data.timestamp);
                const today = new Date();
                const diffTime = Math.abs(today - saveDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return Math.min(diffDays, 30); // Cap at 30 days
            } catch (e) {
                return 0;
            }
        }

        function markMilestoneComplete(id) {
            let milestones = JSON.parse(localStorage.getItem('eduflow_milestones') || '[]');
            const milestone = milestones.find(m => m.id === id);
            if (milestone) {
                milestone.achieved = true;
                milestone.current = milestone.target;
                localStorage.setItem('eduflow_milestones', JSON.stringify(milestones));
                loadMilestones();
                
                // Show celebration
                alert(`ğŸ‰ Congratulations! You've achieved: ${milestone.title}\n\n${milestone.description}\n\nKeep up the great work!`);
            }
        }

        function addCustomMilestone() {
            const title = prompt('Enter milestone title:');
            if (!title) return;
            
            const description = prompt('Enter milestone description:');
            if (!description) return;
            
            const target = parseInt(prompt('Enter target number:'));
            if (!target || target <= 0) return;
            
            const milestones = JSON.parse(localStorage.getItem('eduflow_milestones') || '[]');
            const newMilestone = {
                id: Date.now(),
                title,
                description,
                achieved: false,
                target,
                current: 0,
                type: 'custom'
            };
            
            milestones.push(newMilestone);
            localStorage.setItem('eduflow_milestones', JSON.stringify(milestones));
            loadMilestones();
        }

        function deleteMilestone(id) {
            if (confirm('Are you sure you want to delete this milestone?')) {
                let milestones = JSON.parse(localStorage.getItem('eduflow_milestones') || '[]');
                milestones = milestones.filter(m => m.id !== id);
                localStorage.setItem('eduflow_milestones', JSON.stringify(milestones));
                loadMilestones();
            }
        }

        function updateMilestoneProgress(type, increment = 1) {
            let milestones = JSON.parse(localStorage.getItem('eduflow_milestones') || '[]');
            milestones.forEach(milestone => {
                if (milestone.type === type && !milestone.achieved) {
                    milestone.current = Math.min(milestone.target, milestone.current + increment);
                    milestone.achieved = milestone.current >= milestone.target;
                }
            });
            localStorage.setItem('eduflow_milestones', JSON.stringify(milestones));
        }

        function updateOverviewStats() {
            document.getElementById('totalSubjects').textContent = subjects.length;
            document.getElementById('completedLessons').textContent = lessons.filter(l => l.status === 'completed').length;
            
            const avgProgress = subjects.reduce((sum, subject) => sum + subject.progress, 0) / subjects.length;
            document.getElementById('overallProgress').textContent = Math.round(avgProgress);
            
            const totalHours = lessons.reduce((sum, lesson) => sum + lesson.duration, 0) / 60;
            document.getElementById('weeklyHours').textContent = Math.round(totalHours);
        }

        // Export and save functions
        function exportToPDF() {
            // Create a comprehensive HTML document for PDF export
            const learnerName = document.getElementById('learnerName')?.value || 'Not Set';
            const teacherName = document.getElementById('teacherName')?.value || 'Not Set';
            const gradeLevel = document.getElementById('globalGradeLevel')?.value || 'Not Set';
            const academicYear = document.getElementById('globalAcademicYear')?.value || 'Not Set';
            
            // Get table data
            const monthlyTable = document.querySelector('#subject-wise table');
            const weeklyTable = document.querySelector('#period-wise table');
            const scheduleTable = document.querySelector('#schedule table');
            
            // Create PDF-friendly HTML content
            const pdfContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>EduFlow Curriculum Plan - ${learnerName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 30px; padding: 20px; background: #f0f9ff; border-radius: 8px; }
                        .header h1 { color: #0369a1; margin-bottom: 10px; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0; }
                        .info-box { padding: 15px; background: #f8fafc; border-radius: 6px; border-left: 4px solid #3b82f6; }
                        .section { margin: 30px 0; page-break-inside: avoid; }
                        .section h2 { color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 12px; }
                        th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; vertical-align: top; }
                        th { background: #f3f4f6; font-weight: bold; }
                        .planning-text { background: #f9fafb; padding: 15px; border-radius: 6px; margin: 10px 0; }
                        .footer { margin-top: 40px; text-align: center; color: #6b7280; font-size: 12px; }
                        @media print { 
                            body { margin: 15px; } 
                            .section { page-break-inside: avoid; }
                            table { font-size: 10px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ğŸ“– EduFlow Curriculum Plan</h1>
                        <p>Smart Curriculum Design for Modern Educators</p>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-box">
                            <strong>ğŸ‘¨â€ğŸ“ Learner:</strong> ${learnerName}
                        </div>
                        <div class="info-box">
                            <strong>ğŸ‘©â€ğŸ« Teacher:</strong> ${teacherName}
                        </div>
                        <div class="info-box">
                            <strong>ğŸ“ Grade Level:</strong> ${gradeLevel}
                        </div>
                        <div class="info-box">
                            <strong>ğŸ“… Academic Year:</strong> ${academicYear}
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>ğŸ“š Subject Overview</h2>
                        ${subjects.map(subject => `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px;">
                                <strong>${subject.emoji} ${subject.name}</strong> - ${subject.progress}% Complete
                                <br><small>${subject.description}</small>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="section">
                        <h2>ğŸ“Š Monthly Curriculum Planning</h2>
                        ${monthlyTable ? monthlyTable.outerHTML : '<p>No monthly planning data available</p>'}
                    </div>
                    
                    <div class="section">
                        <h2>ğŸ“… Weekly Subject Planning</h2>
                        ${weeklyTable ? weeklyTable.outerHTML : '<p>No weekly planning data available</p>'}
                    </div>
                    
                    <div class="section">
                        <h2>ğŸ• Daily Schedule</h2>
                        ${scheduleTable ? scheduleTable.outerHTML : '<p>No schedule data available</p>'}
                    </div>
                    
                    <div class="section">
                        <h2>ğŸ¯ Planning Details</h2>
                        <div class="planning-text">
                            <h3>Learning Goals</h3>
                            <p>${document.getElementById('learningGoals')?.value || 'Not specified'}</p>
                        </div>
                        <div class="planning-text">
                            <h3>Prerequisites</h3>
                            <p>${document.getElementById('prerequisites')?.value || 'Not specified'}</p>
                        </div>
                        <div class="planning-text">
                            <h3>Teaching Notes</h3>
                            <p>${document.getElementById('teachingNotes')?.value || 'Not specified'}</p>
                        </div>
                        <div class="planning-text">
                            <h3>Cross-Curricular Connections</h3>
                            <p>${document.getElementById('mappingInsights')?.value || 'Not specified'}</p>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>Generated by EduFlow Planner on ${new Date().toLocaleDateString()}</p>
                        <p>Â© ${new Date().getFullYear()} EduFlow - Smart Curriculum Design</p>
                    </div>
                </body>
                </html>
            `;
            
            // Create and download the HTML file
            const blob = new Blob([pdfContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `EduFlow_Curriculum_${learnerName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('ğŸ“„ Curriculum Plan Exported!\n\nYour complete curriculum plan has been downloaded as an HTML file. You can:\n\nâ€¢ Open it in any web browser\nâ€¢ Print it as PDF using your browser (Ctrl+P â†’ Save as PDF)\nâ€¢ Share it with colleagues\nâ€¢ Archive it for your records\n\nThe file includes all your planning data, tables, and subject information in a clean, printable format.');
        }

        function printPlanner() {
            // Create a modal for print options
            const printModal = document.createElement('div');
            printModal.className = 'modal active';
            printModal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    <h3 style="margin-bottom: 20px; color: #1f2937;">ğŸ–¨ï¸ Print Options</h3>
                    <p style="margin-bottom: 20px; color: #6b7280;">Choose what you'd like to print:</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;">
                        <button class="btn" onclick="printSection('entire'); this.closest('.modal').remove();" style="justify-content: flex-start;">
                            ğŸ“„ Print Entire Planner
                        </button>
                        <button class="btn btn-secondary" onclick="printSection('schedule'); this.closest('.modal').remove();" style="justify-content: flex-start;">
                            ğŸ• Print Daily Schedule Only
                        </button>
                        <button class="btn btn-secondary" onclick="printSection('weekly'); this.closest('.modal').remove();" style="justify-content: flex-start;">
                            ğŸ“… Print Weekly Planning Only
                        </button>
                        <button class="btn btn-secondary" onclick="printSection('monthly'); this.closest('.modal').remove();" style="justify-content: flex-start;">
                            ğŸ“Š Print Monthly Curriculum Only
                        </button>
                        <button class="btn btn-secondary" onclick="printSection('subjects'); this.closest('.modal').remove();" style="justify-content: flex-start;">
                            ğŸ“š Print Subject Overview Only
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(printModal);
        }

        function printSection(section) {
            // Create a new window for printing to avoid disrupting the main app
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            
            const headerContent = document.querySelector('.header').outerHTML;
            const participantInfo = document.getElementById('headerSubtitle').outerHTML;
            
            let contentToPrint = '';
            let title = '';
            
            switch(section) {
                case 'schedule':
                    const scheduleDiv = document.getElementById('schedule');
                    const scheduleTable = scheduleDiv.querySelector('table');
                    contentToPrint = scheduleTable ? `<div style="padding: 20px;"><h2>ğŸ• Daily Schedule</h2>${scheduleTable.outerHTML}</div>` : '<p>No schedule data found</p>';
                    title = 'Daily Schedule';
                    break;
                case 'weekly':
                    const weeklyTable = document.querySelector('#weeklyPlanTable');
                    if (weeklyTable) {
                        const weeklyTableClone = weeklyTable.cloneNode(true);
                        const weeklyTableContainer = weeklyTable.closest('div');
                        const weeklyTableHeader = weeklyTableContainer.querySelector('table thead');
                        contentToPrint = `<div style="padding: 20px;"><h2>ğŸ“… Weekly Subject Planning</h2><table style="width: 100%; border-collapse: collapse;">${weeklyTableHeader.outerHTML}${weeklyTableClone.outerHTML}</table></div>`;
                    } else {
                        contentToPrint = '<p>No weekly planning data found</p>';
                    }
                    title = 'Weekly Planning';
                    break;
                case 'monthly':
                    const monthlyTable = document.querySelector('#monthlyPlanTable');
                    if (monthlyTable) {
                        const monthlyTableClone = monthlyTable.cloneNode(true);
                        const monthlyTableContainer = monthlyTable.closest('div');
                        const monthlyTableHeader = monthlyTableContainer.querySelector('table thead');
                        contentToPrint = `<div style="padding: 20px;"><h2>ğŸ“Š Monthly Curriculum Planning</h2><table style="width: 100%; border-collapse: collapse;">${monthlyTableHeader.outerHTML}${monthlyTableClone.outerHTML}</table></div>`;
                    } else {
                        contentToPrint = '<p>No monthly planning data found</p>';
                    }
                    title = 'Monthly Curriculum Planning';
                    break;
                case 'subjects':
                    const subjectsGrid = document.getElementById('subjectsGrid');
                    contentToPrint = subjectsGrid ? `<div style="padding: 20px;"><h2>ğŸ“š Subject Overview</h2>${subjectsGrid.outerHTML}</div>` : '<p>No subjects data found</p>';
                    title = 'Subject Overview';
                    break;
                default:
                    window.print();
                    return;
            }
            
            // Write content to new window
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>EduFlow - ${title}</title>
                    <style>
                        * { box-sizing: border-box; }
                        body { 
                            margin: 0; 
                            padding: 20px; 
                            font-family: 'Arial', sans-serif; 
                            background: white;
                            color: #1f2937;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 30px; 
                            padding: 20px; 
                            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 25%, #10b981 50%, #059669 75%, #047857 100%);
                            color: white;
                            border-radius: 12px;
                            -webkit-print-color-adjust: exact;
                            color-adjust: exact;
                        }
                        .header h1 { 
                            margin: 0 0 10px 0; 
                            font-size: 2rem; 
                            font-weight: 800;
                        }
                        .header p { 
                            margin: 0; 
                            font-size: 1.1rem; 
                            opacity: 0.9;
                        }
                        #headerSubtitle {
                            padding: 20px;
                            background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%);
                            border-radius: 12px;
                            margin-bottom: 20px;
                            border: 1px solid rgba(59, 130, 246, 0.2);
                        }
                        .form-group {
                            display: inline-block;
                            margin: 0 20px 10px 0;
                            vertical-align: top;
                        }
                        .form-group label {
                            display: block;
                            font-weight: 600;
                            color: #374151;
                            margin-bottom: 4px;
                            font-size: 0.9rem;
                        }
                        .form-control {
                            padding: 8px 12px;
                            border: 1px solid #d1d5db;
                            border-radius: 6px;
                            background: white;
                            color: #374151;
                            font-size: 0.9rem;
                            min-width: 150px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0;
                            background: white;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        th { 
                            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 50%, #1d4ed8 100%);
                            color: white;
                            padding: 12px 8px;
                            font-weight: 600;
                            font-size: 11px;
                            text-align: left;
                            border: 1px solid #1e40af;
                            -webkit-print-color-adjust: exact;
                            color-adjust: exact;
                        }
                        td { 
                            padding: 8px;
                            border: 1px solid #e5e7eb;
                            font-size: 10px;
                            vertical-align: top;
                            line-height: 1.3;
                        }
                        textarea, input, select { 
                            border: none;
                            background: transparent;
                            font-size: 9px;
                            padding: 2px;
                            width: 100%;
                            resize: none;
                            font-family: inherit;
                            line-height: 1.2;
                        }
                        .subject-card {
                            display: inline-block;
                            width: 300px;
                            margin: 10px;
                            padding: 16px;
                            border: 2px solid #e5e7eb;
                            border-radius: 12px;
                            background: white;
                            vertical-align: top;
                        }
                        .subject-card h3 {
                            margin: 0 0 8px 0;
                            color: #1f2937;
                            font-size: 1.1rem;
                        }
                        .subject-card p {
                            margin: 0 0 12px 0;
                            color: #6b7280;
                            font-size: 0.9rem;
                        }
                        .progress-bar {
                            background: #f3f4f6;
                            height: 6px;
                            border-radius: 3px;
                            overflow: hidden;
                            margin-bottom: 8px;
                        }
                        .progress-fill {
                            height: 100%;
                            background: linear-gradient(90deg, #3b82f6, #10b981);
                            border-radius: 3px;
                        }
                        .btn { display: none !important; }
                        .nav-tabs { display: none !important; }
                        .modal { display: none !important; }
                        
                        @media print {
                            @page { 
                                size: A4 landscape; 
                                margin: 0.5in; 
                            }
                            body { 
                                font-size: 9px;
                                line-height: 1.2;
                            }
                            .header {
                                background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 25%, #10b981 50%, #059669 75%, #047857 100%) !important;
                                -webkit-print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                            th {
                                background: linear-gradient(135deg, #2563eb 0%, #3b82f6 50%, #1d4ed8 100%) !important;
                                -webkit-print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                            table { 
                                font-size: 8px;
                                page-break-inside: avoid;
                            }
                            th, td { 
                                padding: 4px;
                                font-size: 8px;
                            }
                            textarea, input { 
                                font-size: 7px;
                                line-height: 1.1;
                            }
                            .subject-card {
                                width: 280px;
                                margin: 8px;
                                padding: 12px;
                                page-break-inside: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${headerContent}
                    ${participantInfo}
                    <div style="margin-top: 20px;">
                        ${contentToPrint}
                    </div>
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 0.9rem; color: #6b7280; text-align: center;">
                        <p>Generated by EduFlow Planner on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load, then print
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                
                // Close the print window after printing
                setTimeout(() => {
                    printWindow.close();
                }, 1000);
            }, 500);
        }

        function saveTemplate() {
            const templateData = {
                learnerName: document.getElementById('learnerName')?.value || '',
                teacherName: document.getElementById('teacherName')?.value || '',
                subjects: subjects,
                lessons: lessons,
                planningData: {
                    learningGoals: document.getElementById('learningGoals')?.value || '',
                    prerequisites: document.getElementById('prerequisites')?.value || '',
                    teachingNotes: document.getElementById('teachingNotes')?.value || '',
                    mappingInsights: document.getElementById('mappingInsights')?.value || ''
                },
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('eduflow_template', JSON.stringify(templateData));
            alert('ğŸ’¾ Template Saved Successfully!\n\nYour curriculum template has been saved locally. You can restore it anytime by refreshing the page.');
        }

        // Daily schedule functions
        function loadScheduleTemplate() {
            const template = document.getElementById('scheduleTemplate').value;
            const tableBody = document.getElementById('scheduleTable');
            tableBody.innerHTML = '';
            
            let timeSlots = [];
            
            switch(template) {
                case 'standard':
                    timeSlots = [
                        '8:00 AM - 8:30 AM', '8:30 AM - 9:30 AM', '9:30 AM - 10:30 AM', '10:30 AM - 10:45 AM',
                        '10:45 AM - 11:45 AM', '11:45 AM - 12:45 PM', '12:45 PM - 1:30 PM', '1:30 PM - 2:30 PM', '2:30 PM - 3:00 PM'
                    ];
                    break;
                case 'extended':
                    timeSlots = [
                        '7:00 AM - 7:30 AM', '7:30 AM - 8:30 AM', '8:30 AM - 9:30 AM', '9:30 AM - 10:30 AM', '10:30 AM - 10:45 AM',
                        '10:45 AM - 11:45 AM', '11:45 AM - 12:45 PM', '12:45 PM - 1:30 PM', '1:30 PM - 2:30 PM', 
                        '2:30 PM - 3:30 PM', '3:30 PM - 4:30 PM', '4:30 PM - 5:00 PM'
                    ];
                    break;
                case 'flexible':
                    timeSlots = [
                        'Morning Block 1', 'Morning Block 2', 'Mid-Morning Break', 'Late Morning Block', 
                        'Lunch Period', 'Afternoon Block 1', 'Afternoon Block 2', 'Evening Wrap-up'
                    ];
                    break;
                default:
                    timeSlots = ['Custom Time Slot 1', 'Custom Time Slot 2', 'Custom Time Slot 3'];
            }
            
            timeSlots.forEach(timeSlot => {
                addTimeSlot(timeSlot);
            });
        }

        function addTimeSlot(timeSlot = '') {
    const tableBody = document.getElementById('scheduleTable');
    const row = document.createElement('tr');

    row.innerHTML = `
        <td style="padding: 8px; border: 1px solid #e5e7eb;">
            <input type="text" value="${timeSlot}" placeholder="Time slot" style="width: 100%; border: none; background: transparent; padding: 4px; font-weight: 600;" onchange="updateWeeklyFromDaily()">
        </td>
        <td style="padding: 8px; border: 1px solid #e5e7eb;">
            <select style="width: 100%; border: none; background: transparent; padding: 4px;" onchange="updateWeeklyFromDaily()">
                <option value="">Select Subject</option>
                <option value="mathematics">ğŸ”¢ Mathematics</option>
                <option value="science">ğŸ”¬ Science</option>
                <option value="english">ğŸ“ English</option>
                <option value="history">ğŸ›ï¸ History</option>
                <option value="art">ğŸ¨ Art</option>
                <option value="music">ğŸµ Music</option>
                <option value="break">â˜• Break</option>
                <option value="lunch">ğŸ½ï¸ Lunch</option>
                <option value="pe">ğŸƒ Physical Education</option>
                <option value="other">ğŸ“š Other</option>
            </select>
        </td>
        <td style="padding: 8px; border: 1px solid #e5e7eb;">
            <textarea placeholder="Learning objectives for this time slot..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px;" onchange="updateWeeklyFromDaily()"></textarea>
        </td>
        <td style="padding: 8px; border: 1px solid #e5e7eb;">
            <textarea placeholder="Activities and tasks..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px;" onchange="updateWeeklyFromDaily()"></textarea>
        </td>
        <td style="padding: 8px; border: 1px solid #e5e7eb;">
            <textarea placeholder="Materials needed..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px;" onchange="updateWeeklyFromDaily()"></textarea>
        </td>
        <td style="padding: 8px; border: 1px solid #e5e7eb;">
            <textarea placeholder="Notes..." style="width: 100%; border: none; background: transparent; resize: vertical; min-height: 50px; padding: 4px;" onchange="updateWeeklyFromDaily()"></textarea>
        </td>
        <td style="padding: 8px; border: 1px solid #e5e7eb;">
            <select class="progress-matrix" style="width: 100%; border: none; background: transparent; padding: 4px;" onchange="saveProgressMatrix()">
                <option value="">Select Progress</option>
                <option value="Excellent">Excellent</option>
                <option value="Good">Good</option>
                <option value="Needs Improvement">Needs Improvement</option>
            </select>
        </td>
        `;

        tableBody.appendChild(row);
        }
        // Weekly schedule functions
        function showWeeklyView() {
            openModal('weeklyScheduleModal');
            generateWeeklySchedule();
        }

        // Store daily schedule data for each day
        let dailyScheduleData = {
            monday: [],
            tuesday: [],
            wednesday: [],
            thursday: [],
            friday: [],
            saturday: [],
            sunday: []
        };

        function updateWeeklyFromDaily() {
            // Get current day and save its schedule data
            const currentDay = document.getElementById('scheduleDay').value;
            const scheduleTable = document.getElementById('scheduleTable');
            const rows = scheduleTable.querySelectorAll('tr');
            
            dailyScheduleData[currentDay] = [];
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    const timeSlot = cells[0].querySelector('input')?.value || '';
                    const subject = cells[1].querySelector('select')?.value || '';
                    const subjectText = cells[1].querySelector('select')?.selectedOptions[0]?.textContent || '';
                    
                    dailyScheduleData[currentDay].push({
                        time: timeSlot,
                        subject: subject,
                        subjectText: subjectText
                    });
                }
            });
            
            console.log(`Updated ${currentDay} schedule data`);
        }

        function generateWeeklySchedule() {
            const tableBody = document.getElementById('weeklyScheduleTable');
            tableBody.innerHTML = '';
            
            // Get all unique time slots from daily schedules
            const allTimeSlots = new Set();
            Object.values(dailyScheduleData).forEach(dayData => {
                dayData.forEach(slot => {
                    if (slot.time) allTimeSlots.add(slot.time);
                });
            });
            
            // Custom time sorting function
            function sortTimeSlots(timeSlots) {
                return timeSlots.sort((a, b) => {
                    // Convert time strings to comparable format
                    const timeA = convertTimeToMinutes(a);
                    const timeB = convertTimeToMinutes(b);
                    return timeA - timeB;
                });
            }
            
            function convertTimeToMinutes(timeStr) {
                // Handle various time formats
                const cleanTime = timeStr.replace(/[^\d:APMapm\s-]/g, '').trim();
                let time = cleanTime.split('-')[0].trim(); // Get start time if range
                
                if (!time.includes(':')) {
                    // Handle formats like "8 AM" or "Morning Block 1"
                    if (time.includes('Morning')) return 480; // 8 AM
                    if (time.includes('Afternoon')) return 780; // 1 PM
                    if (time.includes('Evening')) return 1020; // 5 PM
                    return 480; // Default to 8 AM
                }
                
                const [hourMin, period] = time.split(/\s+/);
                const [hour, minute = '0'] = hourMin.split(':');
                let hours = parseInt(hour);
                const minutes = parseInt(minute);
                
                if (period && period.toLowerCase().includes('pm') && hours !== 12) {
                    hours += 12;
                } else if (period && period.toLowerCase().includes('am') && hours === 12) {
                    hours = 0;
                }
                
                return hours * 60 + minutes;
            }
            
            // If no daily data exists, use default time slots
            const timeSlots = allTimeSlots.size > 0 ? sortTimeSlots(Array.from(allTimeSlots)) : [
                '7:00 AM', '8:00 AM', '9:00 AM', '10:00 AM', '11:00 AM', '12:00 PM', 
                '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM', '5:00 PM', '6:00 PM', '7:00 PM', '8:00 PM'
            ];
            
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            
            timeSlots.forEach(time => {
                const row = document.createElement('tr');
                let rowHTML = `<td style="padding: 8px; border: 1px solid #e5e7eb; font-weight: 600; background: #f8fafc;">${time}</td>`;
                
                days.forEach(day => {
                    const dayData = dailyScheduleData[day] || [];
                    const timeSlotData = dayData.find(slot => slot.time === time);
                    const subjectText = timeSlotData ? timeSlotData.subjectText : '';
                    
                    rowHTML += `<td style="padding: 8px; border: 1px solid #e5e7eb;"><input type="text" value="${subjectText}" placeholder="Subject/Activity" style="width: 100%; border: none; background: transparent; padding: 4px;"></td>`;
                });
                
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });
        }

        function exportWeeklySchedule() {
            // Get current weekly schedule data
            const weeklyTable = document.getElementById('weeklyScheduleTable');
            if (!weeklyTable || weeklyTable.children.length === 0) {
                alert('âŒ No weekly schedule data to export.\n\nPlease fill in your daily schedules first, then click "View Full Week" to generate the weekly overview.');
                return;
            }
            
            // Get participant info
            const learnerName = document.getElementById('learnerName')?.value || 'Student';
            const teacherName = document.getElementById('teacherName')?.value || 'Teacher';
            const gradeLevel = document.getElementById('globalGradeLevel')?.value || 'Not Set';
            const academicYear = document.getElementById('globalAcademicYear')?.value || 'Not Set';
            
            // Create export content
            const exportContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Weekly Schedule - ${learnerName}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px; 
                            background: white;
                            color: #1f2937;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 30px; 
                            padding: 20px; 
                            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                            color: white;
                            border-radius: 12px;
                        }
                        .header h1 { 
                            margin: 0 0 10px 0; 
                            font-size: 2rem; 
                        }
                        .info-grid { 
                            display: grid; 
                            grid-template-columns: repeat(2, 1fr); 
                            gap: 20px; 
                            margin: 20px 0; 
                        }
                        .info-box { 
                            padding: 15px; 
                            background: #f8fafc; 
                            border-radius: 6px; 
                            border-left: 4px solid #f59e0b; 
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0;
                            background: white;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        th { 
                            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                            color: white;
                            padding: 12px 8px;
                            font-weight: 600;
                            text-align: left;
                            border: 1px solid #d97706;
                        }
                        td { 
                            padding: 10px 8px;
                            border: 1px solid #e5e7eb;
                            font-size: 12px;
                            vertical-align: top;
                        }
                        input { 
                            border: none;
                            background: transparent;
                            font-size: 11px;
                            width: 100%;
                            font-family: inherit;
                        }
                        .footer { 
                            margin-top: 40px; 
                            text-align: center; 
                            color: #6b7280; 
                            font-size: 12px; 
                        }
                        
                        @media print {
                            @page { 
                                size: A4 landscape; 
                                margin: 0.5in; 
                            }
                            body { font-size: 10px; }
                            .header { 
                                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
                                -webkit-print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                            th {
                                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
                                -webkit-print-color-adjust: exact !important;
                                color-adjust: exact !important;
                            }
                            table { font-size: 9px; }
                            th, td { padding: 6px 4px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ğŸ“… Weekly Schedule</h1>
                        <p>Complete Weekly Overview</p>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-box">
                            <strong>ğŸ‘¨â€ğŸ“ Student:</strong> ${learnerName}
                        </div>
                        <div class="info-box">
                            <strong>ğŸ‘©â€ğŸ« Teacher:</strong> ${teacherName}
                        </div>
                        <div class="info-box">
                            <strong>ğŸ“ Grade Level:</strong> ${gradeLevel}
                        </div>
                        <div class="info-box">
                            <strong>ğŸ“… Academic Year:</strong> ${academicYear}
                        </div>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <h2 style="color: #1f2937; margin-bottom: 20px;">ğŸ“Š Weekly Schedule Overview</h2>
                        ${weeklyTable.closest('table').outerHTML}
                    </div>
                    
                    <div class="footer">
                        <p>Generated by EduFlow Planner on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                        <p>Â© ${new Date().getFullYear()} EduFlow - Smart Curriculum Design</p>
                    </div>
                </body>
                </html>
            `;
            
            // Create and download the file
            const blob = new Blob([exportContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Weekly_Schedule_${learnerName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('ğŸ“„ Weekly Schedule Exported!\n\nYour complete weekly schedule has been downloaded as an HTML file. You can:\n\nâ€¢ Open it in any web browser\nâ€¢ Print it as PDF (Ctrl+P â†’ Save as PDF)\nâ€¢ Share it with others\nâ€¢ Keep it for your records\n\nThe file shows your complete weekly schedule in a clean, printable format.');
        }

        function updateDaySchedule() {
            // Save current day's data before switching
            updateWeeklyFromDaily();
            
            const selectedDay = document.getElementById('scheduleDay').value;
            const scheduleTable = document.getElementById('scheduleTable');
            
            // Clear current table
            scheduleTable.innerHTML = '';
            
            // Load data for selected day
            const dayData = dailyScheduleData[selectedDay] || [];
            
            if (dayData.length > 0) {
                // Restore saved data for this day
                dayData.forEach(slotData => {
                    addTimeSlot(slotData.time);
                    const lastRow = scheduleTable.lastElementChild;
                    if (lastRow) {
                        const subjectSelect = lastRow.cells[1].querySelector('select');
                        if (subjectSelect && slotData.subject) {
                            subjectSelect.value = slotData.subject;
                        }
                    }
                });
            } else {
                // Load default template for new day
                loadScheduleTemplate();
            }
            
            console.log(`Switched to ${selectedDay} schedule`);
        }

        // Update header info with participant information
        function updateHeaderInfo() {
            const learnerName = document.getElementById('learnerName')?.value || '';
            const teacherName = document.getElementById('teacherName')?.value || '';
            const gradeLevel = document.getElementById('globalGradeLevel')?.value || '';
            const academicYear = document.getElementById('globalAcademicYear')?.value || '';
            
            // Update display fields
            const displayGrade = document.getElementById('displayGrade');
            const displayYear = document.getElementById('displayYear');
            
            if (displayGrade) {
                displayGrade.value = gradeLevel || '';
                displayGrade.placeholder = gradeLevel ? gradeLevel : 'Select grade level in Academic Calendar';
            }
            
            if (displayYear) {
                displayYear.value = academicYear || '';
                displayYear.placeholder = academicYear ? academicYear : 'Academic year will appear here';
            }
        }

        // Legacy function for compatibility
        function updateHeaderSubtitle() {
            updateHeaderInfo();
        }

        // Add event listeners for header updates
        function addHeaderUpdateListeners() {
            const fieldsToWatch = ['learnerName', 'teacherName', 'globalGradeLevel', 'globalAcademicYear', 'globalSchoolYearStart'];
            fieldsToWatch.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Clean approach - only add specific listeners for name fields
                    if (fieldId === 'learnerName' || fieldId === 'teacherName') {
                        field.addEventListener('input', function(e) {
                            updateHeaderInfo();
                        });
                        field.addEventListener('keyup', function(e) {
                            updateHeaderInfo();
                        });
                    } else {
                        field.addEventListener('change', function(e) {
                            updateHeaderInfo();
                            triggerAutoSave();
                        });
                    }
                    
                    if (fieldId === 'globalSchoolYearStart') {
                        field.addEventListener('change', updateAcademicYearFromStart);
                    }
                }
            });
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date for lesson form to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('lessonDate').value = today;
            document.getElementById('scheduleDate').value = today;
            
            // Set default school year start to current September in global settings
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            const schoolYear = currentMonth >= 8 ? currentYear : currentYear - 1; // September = month 8
            document.getElementById('globalSchoolYearStart').value = `${schoolYear}-09`;
            
            // Initialize global settings
            updateGlobalCountrySettings();
            updateGlobalCalendarSystem();
            
            // Try to load auto-saved data first, then fall back to template
            const autoSaveLoaded = loadAutoSavedData();
            
            if (!autoSaveLoaded) {
                // Load saved template if exists and no auto-save data
                const savedTemplate = localStorage.getItem('eduflow_template');
                if (savedTemplate) {
                    try {
                        const data = JSON.parse(savedTemplate);
                        if (data.learnerName) document.getElementById('learnerName').value = data.learnerName;
                        if (data.teacherName) document.getElementById('teacherName').value = data.teacherName;
                        if (data.planningData) {
                            if (data.planningData.learningGoals) document.getElementById('learningGoals').value = data.planningData.learningGoals;
                            if (data.planningData.prerequisites) document.getElementById('prerequisites').value = data.planningData.prerequisites;
                            if (data.planningData.teachingNotes) document.getElementById('teachingNotes').value = data.planningData.teachingNotes;
                            if (data.planningData.mappingInsights) document.getElementById('mappingInsights').value = data.planningData.mappingInsights;
                        }
                    } catch (e) {
                        console.log('Could not load saved template');
                    }
                }
            }
            
            // Initialize all interconnected data
            updateAllSections();
            addHeaderUpdateListeners();
            
            // Setup auto-save functionality
            setupAutoSaveListeners();
            createSaveIndicator();
            
            // Update header info after data is loaded
            setTimeout(() => {
                updateHeaderInfo();
                updateSubjectTitle();
            }, 100);
        });

         // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }); // <- This was missing the closing brace!

        // Simple Translation System
        const translations = {
            en: {
                interfaceLanguage: "ğŸŒ Interface Language",
                learnerName: "Learner Name", 
                teacherName: "Teacher Name",
                countryRegion: "Country/Region",
                calendarSystem: "Calendar System",
                schoolYearStart: "School Year Start",
                academicYear: "Academic Year",
                gradeLevel: "Grade Level"
            },
            es: {
                interfaceLanguage: "ğŸŒ Idioma de Interfaz",
                learnerName: "Nombre del Estudiante",
                teacherName: "Nombre del Profesor", 
                countryRegion: "PaÃ­s/RegiÃ³n",
                calendarSystem: "Sistema de Calendario",
                schoolYearStart: "Inicio del AÃ±o Escolar",
                academicYear: "AÃ±o AcadÃ©mico",
                gradeLevel: "Nivel de Grado"
            },
            fr: {
                interfaceLanguage: "ğŸŒ Langue d'Interface",
                learnerName: "Nom de l'Apprenant",
                teacherName: "Nom de l'Enseignant",
                countryRegion: "Pays/RÃ©gion", 
                calendarSystem: "SystÃ¨me de Calendrier",
                schoolYearStart: "DÃ©but de l'AnnÃ©e Scolaire",
                academicYear: "AnnÃ©e AcadÃ©mique",
                gradeLevel: "Niveau Scolaire"
            },
            de: {
                interfaceLanguage: "ğŸŒ OberflÃ¤chensprache",
                learnerName: "Name des Lernenden",
                teacherName: "Lehrername",
                countryRegion: "Land/Region",
                calendarSystem: "Kalendersystem", 
                schoolYearStart: "Schuljahresbeginn",
                academicYear: "Schuljahr",
                gradeLevel: "Klassenstufe"
            },
            zh: {
                interfaceLanguage: "ğŸŒ ç•Œé¢è¯­è¨€",
                learnerName: "å­¦ä¹ è€…å§“å",
                teacherName: "æ•™å¸ˆå§“å",
                countryRegion: "å›½å®¶/åœ°åŒº",
                calendarSystem: "æ—¥å†ç³»ç»Ÿ",
                schoolYearStart: "å­¦å¹´å¼€å§‹",
                academicYear: "å­¦å¹´",
                gradeLevel: "å¹´çº§"
            },
            ja: {
                interfaceLanguage: "ğŸŒ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¨€èª",
                learnerName: "å­¦ç¿’è€…å",
                teacherName: "æ•™å¸«å", 
                countryRegion: "å›½/åœ°åŸŸ",
                calendarSystem: "ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ",
                schoolYearStart: "å­¦å¹´é–‹å§‹",
                academicYear: "å­¦å¹´åº¦",
                gradeLevel: "å­¦å¹´"
            }
        };

         function changeLanguage(lang) {
            const t = translations[lang];
            if (!t) return;
            
            // Direct text replacement approach
            const textReplacements = {
                "Learner's Name": t.learnerName,
                "Teacher's Name": t.teacherName,
                "Country/Region": t.countryRegion,
                "Calendar System": t.calendarSystem,
                "School Year Start": t.schoolYearStart,
                "Academic Year": t.academicYear,
                "Grade Level": t.gradeLevel,
                "Language Interface": t.interfaceLanguage
            };
            
            // Find and replace text in all elements
            document.querySelectorAll('*').forEach(element => {
                // Only check text nodes, not nested elements
                if (element.children.length === 0) {
                    const text = element.textContent.trim();
                    if (textReplacements[text]) {
                        element.textContent = textReplacements[text];
                    }
                }
            });
            
            // Also try labels specifically
            document.querySelectorAll('label').forEach(label => {
                const text = label.textContent.trim();
                if (textReplacements[text]) {
                    label.textContent = textReplacements[text];
                }
            });
            
            localStorage.setItem('selectedLanguage', lang);
        }

        // Load saved language on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedLang = localStorage.getItem('selectedLanguage') || 'en';
            const select = document.getElementById('globalInterfaceLanguage');
            if (select) {
                select.value = savedLang;
                changeLanguage(savedLang);
            }
        });
    </script>
</body>
</html>
